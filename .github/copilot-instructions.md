# GitHub Copilot Instructions for Web Turntable Viewer Widget

## Project Overview
このプロジェクトは、Vimeoの360度ターンテーブル動画をインタラクティブに操作できるWeb Componentウィジェットです。

## Critical Rules - DO NOT VIOLATE

### 1. Build Output Management
- **NEVER commit files in `dist/` folder**
- `dist/` folder is auto-generated by GitHub Actions
- All build output is managed by CI/CD pipeline
- Local `npm run build` is for development testing only

### 2. Architecture
- **Web Component ONLY** - No legacy initialization code
- Uses Shadow DOM for complete CSS isolation
- Entry point: `src/index.ts` → registers `<turntable-viewer>` custom element
- Main component: `src/turntable-viewer-element.ts` (Web Component wrapper)
- Core logic: `src/turntable-viewer.ts` (initialized by Web Component)

### 3. Removed/Deprecated Code
These patterns are **NO LONGER USED**:
```typescript
// ❌ DO NOT ADD BACK
function initializeTurntableViewers() { ... }
document.addEventListener('DOMContentLoaded', ...);
window.turntableViewerInstances = new Set();
```

### 4. Attribute Specifications
#### `clockwise-rotation` attribute:
- **DEFAULT**: No attribute = clockwise rotation
- **EXPLICIT**: Must always specify boolean value when used
  - Clockwise: `clockwise-rotation="true"`
  - Counter-clockwise: `clockwise-rotation="false"`
- **DEPRECATED**: `clockwise-rotation` (without value) is no longer supported

#### `show-angle` attribute:
- Optional debug feature
- No value needed: `show-angle`
- Shows rotation angle at bottom of widget

### 5. CSS Strategy
- **Shadow DOM CSS**: `src/turntable-viewer.css` (injected inline via Vite `?inline`)
- **Host element protection**: `:host { all: initial; display: block !important; visibility: visible !important; opacity: 1 !important; }`
- **Internal styles**: No `!important` needed inside Shadow DOM (except `:host`)
- **No `all: unset`**: Breaks iframe rendering

### 6. Version Management
- Version defined in `package.json`
- Update version in multiple files when releasing:
  - `package.json`
  - `README.md` (CDN URLs)
  - `embed-generator/script.ts` (CDN URL)
  - `tests/test-cdn.html` (CDN URL and version display)

## File Structure

```
src/
├── index.ts                    # Entry point, registers Web Component
├── turntable-viewer-element.ts # Web Component wrapper (Shadow DOM)
├── turntable-viewer.ts         # Core widget logic
├── turntable-viewer.css        # Shadow DOM CSS (injected inline)
├── types.ts                    # TypeScript type definitions
├── utils.ts                    # Utility functions
├── progress-manager.ts         # Loading overlay management
├── ui-manager.ts               # UI state management
├── drag-handler.ts             # Drag interaction logic
├── player-initializer.ts       # Vimeo player setup
└── video-config-manager.ts     # Video configuration

tests/
├── test-local.html             # Local build testing (dev server)
├── test-cdn.html               # CDN distribution testing
└── test-shadowdom.html         # Shadow DOM specific tests

embed-generator/
├── index.html                  # Embed code generator UI
├── script.ts                   # Generator logic
└── style.css                   # Generator styles

dist/                           # ⚠️ AUTO-GENERATED - DO NOT COMMIT
├── turntable-viewer.js         # UMD bundle
├── turntable-viewer.esm.js     # ES Module bundle
└── turntable-viewer.css        # Extracted CSS (not used, inline in JS)
```

## Development Workflow

### Local Development
```bash
npm run dev          # Start Vite dev server (http://localhost:3001)
npm run build        # Build for testing (output to dist/)
npm run preview      # Preview production build
```

### Testing
- **Local build**: http://localhost:3001/tests/test-local.html
- **CDN version**: http://localhost:3001/tests/test-cdn.html
- **Embed generator**: http://localhost:3001/embed-generator/

### Release Process
1. Update version in `package.json`, `README.md`, `embed-generator/script.ts`, `tests/test-cdn.html`
2. Commit changes (excluding `dist/`)
3. Create and push Git tag: `git tag vX.X.X-beta -m "Release message"`
4. GitHub Actions builds and attaches assets to release
5. jsDelivr CDN serves from GitHub releases

## Common Patterns

### Web Component Usage
```html
<script src="https://player.vimeo.com/api/player.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/gh/NegativeMind/web-turntable-viewer-widget@v0.1.8-beta/dist/turntable-viewer.js"></script>

<turntable-viewer 
  vimeo-video-id="1118303126" 
  width="480" 
  clockwise-rotation="true">
</turntable-viewer>
```

### TurntableConfig Interface
```typescript
interface TurntableConfig {
    PLAYER_LOAD_DELAY_MS: number;
    DRAG_THROTTLE_MS: number;
    isClockwise: boolean;
    videoId: string;
    showAngle: boolean;
}
```

### Error Handling
- Always use `getErrorMessage(error)` utility for error messages
- Display errors via `ProgressManager.showError()`
- Provide reload button for recoverable errors

## Dependencies

### Runtime
- Vimeo Player API (loaded externally)
- Modern browser with Web Components support

### Development
- TypeScript 5.6+
- Vite 5.4+
- No jQuery, no React, no Vue - pure Web Components

## Performance Considerations
- Throttle drag events (100ms minimum)
- Use `requestAnimationFrame` for smooth updates
- Cancel pending API calls during rapid interactions
- Preload video at key positions (0%, 50%)

## Browser Compatibility
- Chrome/Edge: ✅ Full support
- Firefox: ✅ Full support
- Safari: ✅ Full support (iOS 12+)
- IE11: ❌ No support (requires Web Components polyfill)

## When Suggesting Code Changes

### ✅ DO
- Preserve Shadow DOM architecture
- Keep CSS isolation strategy (`:host` with `!important` on display properties only)
- Use TypeScript strict mode
- Follow existing error handling patterns
- Test with both local and CDN builds

### ❌ DON'T
- Add back legacy initialization code
- Commit `dist/` folder
- Break Shadow DOM encapsulation
- Use `all: unset` in CSS (breaks iframe)
- Add unnecessary `!important` flags inside Shadow DOM
- Suggest jQuery or other heavy frameworks

## Additional Context
- Project started as traditional DOM manipulation
- Migrated to Web Components for CSS isolation
- Removed traditional method completely in v0.1.7+
- CDN distribution via jsDelivr from GitHub releases
