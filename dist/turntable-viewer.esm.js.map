{"version":3,"file":"turntable-viewer.esm.js","sources":["../src/progress-manager.ts","../src/utils.ts","../src/video-config-manager.ts","../src/player-initializer.ts","../src/drag-handler.ts","../src/ui-manager.ts","../src/turntable-viewer.ts","../src/turntable-viewer-element.ts","../src/index.ts"],"sourcesContent":["/**\r\n * プログレスバー管理クラス\r\n * ローディングオーバーレイとプログレスバーの表示・更新・タイムアウト検知を管理\r\n */\r\nimport type { TurntableConfig } from './types';\r\n\r\nexport class ProgressManager {\r\n    private loadingOverlay: HTMLElement;\r\n    private loadingText: HTMLElement;\r\n    private progressFill: HTMLElement;\r\n    private progressText: HTMLElement;\r\n    private container: HTMLElement;\r\n    private iframe: HTMLIFrameElement;\r\n    private config: TurntableConfig;\r\n\r\n    // タイムアウト検知用\r\n    private loadingStartTime: number | null = null;\r\n    private lastProgressTime: number = 0;\r\n    private lastProgressPercentage: number = 0;\r\n\r\n    constructor(\r\n        container: HTMLElement,\r\n        iframe: HTMLIFrameElement,\r\n        loadingOverlay: HTMLElement,\r\n        loadingText: HTMLElement,\r\n        progressFill: HTMLElement,\r\n        progressText: HTMLElement,\r\n        config: TurntableConfig\r\n    ) {\r\n        this.container = container;\r\n        this.iframe = iframe;\r\n        this.loadingOverlay = loadingOverlay;\r\n        this.loadingText = loadingText;\r\n        this.progressFill = progressFill;\r\n        this.progressText = progressText;\r\n        this.config = config;\r\n        this.progressText = progressText;\r\n    }\r\n\r\n    /**\r\n     * プログレスバーを更新\r\n     */\r\n    updateProgress(percentage: number, text: string | null = null): void {\r\n        console.log(`Progress update: ${percentage}% - ${text || 'No text'}`);\r\n\r\n        if (this.progressFill) {\r\n            this.progressFill.style.width = `${percentage}%`;\r\n            console.log(`Progress fill updated to ${percentage}%`);\r\n        } else {\r\n            console.warn('Progress fill element not found');\r\n        }\r\n\r\n        if (this.progressText) {\r\n            this.progressText.textContent = `${Math.round(percentage)}%`;\r\n        } else {\r\n            console.warn('Progress text element not found');\r\n        }\r\n\r\n        if (text && this.loadingText) {\r\n            this.loadingText.textContent = text;\r\n        }\r\n\r\n        // ローディングタイムアウト監視\r\n        this.checkLoadingTimeout(percentage);\r\n    }\r\n\r\n    /**\r\n     * ローディングオーバーレイを表示\r\n     */\r\n    showLoadingOverlay(): void {\r\n        if (this.loadingOverlay) {\r\n            // ローディング中はAngle表示を即座に非表示\r\n            const angleDisplay = this.container.querySelector('#angle-display') as HTMLElement;\r\n            if (angleDisplay) {\r\n                angleDisplay.style.display = 'none';\r\n            }\r\n\r\n            this.loadingOverlay.classList.remove('hidden');\r\n            this.updateProgress(0, 'Initializing video player...');\r\n\r\n            // ローディングオーバーレイのサイズを即座に調整\r\n            this.adjustLoadingOverlaySize();\r\n            // 念のため少し遅延しても再調整\r\n            setTimeout(() => this.adjustLoadingOverlaySize(), 10);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * ローディングオーバーレイを隠す\r\n     */\r\n    hideLoadingOverlay(): void {\r\n        if (this.loadingOverlay) {\r\n            setTimeout(() => {\r\n                this.loadingOverlay.classList.add('hidden');\r\n\r\n                // Angle表示を再表示（show-angle属性がある場合のみ）\r\n                if (this.config.showAngle) {\r\n                    const angleDisplay = this.container.querySelector('#angle-display') as HTMLElement;\r\n                    if (angleDisplay) {\r\n                        angleDisplay.style.display = 'block';\r\n                        console.log('Angle display made visible after loading');\r\n                    } else {\r\n                        console.log('Angle display element not found (optional element)');\r\n                    }\r\n                }\r\n            }, 500); // 少し遅延してスムーズに非表示\r\n        }\r\n    }\r\n\r\n    /**\r\n     * ローディングオーバーレイのサイズをiframe要素に合わせて調整\r\n     */\r\n    adjustLoadingOverlaySize(): void {\r\n        if (!this.loadingOverlay || !this.iframe) return;\r\n\r\n        // iframeの実際のサイズ（属性値）を取得\r\n        const iframeWidth = parseInt(this.iframe.getAttribute('width') || '0');\r\n        const iframeHeight = parseInt(this.iframe.getAttribute('height') || '0');\r\n\r\n        // どちらも設定されている場合はそのまま使用\r\n        if (iframeWidth && iframeHeight) {\r\n            this.loadingOverlay.style.width = `${iframeWidth}px`;\r\n            this.loadingOverlay.style.height = `${iframeHeight}px`;\r\n            console.log(`Adjusted loading overlay size: ${iframeWidth}x${iframeHeight}`);\r\n        } else {\r\n            // サイズが未確定の場合はデフォルト値を使用\r\n            const defaultWidth = 480;\r\n            const defaultHeight = Math.round(defaultWidth * (9 / 16));\r\n            this.loadingOverlay.style.width = `${defaultWidth}px`;\r\n            this.loadingOverlay.style.height = `${defaultHeight}px`;\r\n            console.log(`Adjusted loading overlay size to default: ${defaultWidth}x${defaultHeight}`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * ローディングタイムアウトをチェック\r\n     */\r\n    private checkLoadingTimeout(percentage: number): void {\r\n        // 初回またはリセット時にタイマー開始\r\n        if (!this.loadingStartTime) {\r\n            this.loadingStartTime = Date.now();\r\n            this.lastProgressTime = Date.now();\r\n            this.lastProgressPercentage = percentage;\r\n            return;\r\n        }\r\n\r\n        const now = Date.now();\r\n        const totalLoadingTime = now - this.loadingStartTime;\r\n        const timeSinceLastProgress = now - this.lastProgressTime;\r\n\r\n        // プログレスが進んだ場合は時間を更新\r\n        if (percentage > this.lastProgressPercentage) {\r\n            this.lastProgressTime = now;\r\n            this.lastProgressPercentage = percentage;\r\n            return;\r\n        }\r\n\r\n        // 30秒間プログレスが進んでいない場合、または総ローディング時間が60秒を超えた場合\r\n        const STALLED_TIMEOUT = 30000; // 30秒\r\n        const TOTAL_TIMEOUT = 60000;   // 60秒\r\n\r\n        if (timeSinceLastProgress > STALLED_TIMEOUT || totalLoadingTime > TOTAL_TIMEOUT) {\r\n            console.warn(`Loading timeout detected. Stalled: ${timeSinceLastProgress}ms, Total: ${totalLoadingTime}ms`);\r\n\r\n            // ローディングが停止していることを示す\r\n            if (this.loadingText) {\r\n                this.loadingText.textContent = 'ローディングが停止しました - リロードボタンを押してください';\r\n                this.loadingText.style.color = '#ff6b6b';\r\n            }\r\n\r\n            // タイムアウト検出をリセット（重複表示を防ぐ）\r\n            this.loadingStartTime = null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * タイムアウトタイマーをリセット\r\n     */\r\n    resetTimeout(): void {\r\n        this.loadingStartTime = null;\r\n        this.lastProgressTime = 0;\r\n        this.lastProgressPercentage = 0;\r\n    }\r\n\r\n    /**\r\n     * エラー表示（ローディングオーバーレイをエラー表示に変更）\r\n     */\r\n    showError(title: string, message: string): void {\r\n        if (!this.loadingOverlay) return;\r\n\r\n        // ローディングオーバーレイをエラー表示に変更\r\n        this.loadingOverlay.innerHTML = `\r\n                <div class=\"loading-content\">\r\n                    <div class=\"loading-text\" style=\"color: #ff6b6b;\">${title}</div>\r\n                    <div style=\"color: #ffa8a8; font-size: 11px; margin-top: 8px; line-height: 1.4;\">\r\n                        ${message}\r\n                    </div>\r\n                </div>\r\n            `;\r\n        this.loadingOverlay.style.display = 'flex';\r\n        this.loadingOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';\r\n\r\n        console.error(`${title}: ${message}`);\r\n    }\r\n}\r\n","/**\r\n * 共通ユーティリティ関数\r\n */\r\n\r\n/**\r\n * エラーメッセージを取得\r\n */\r\nexport function getErrorMessage(error: unknown): string {\r\n    if (error instanceof Error) return error.message;\r\n    return String(error);\r\n}\r\n\r\n/**\r\n * 遅延関数\r\n */\r\nexport function delay(ms: number): Promise<void> {\r\n    return new Promise(resolve => setTimeout(resolve, ms));\r\n}\r\n\r\n/**\r\n * タイムアウト付きPromise実行\r\n */\r\nexport function withTimeout<T = any>(\r\n    promise: Promise<T>,\r\n    timeoutMs: number,\r\n    errorMessage: string\r\n): Promise<T> {\r\n    return Promise.race([\r\n        promise,\r\n        new Promise<T>((_, reject) =>\r\n            setTimeout(() => reject(new Error(errorMessage || 'Operation timed out')), timeoutMs)\r\n        )\r\n    ]);\r\n}\r\n","import type { TurntableConfig, VideoInfo } from './types';\r\nimport { getErrorMessage, withTimeout, delay } from './utils';\r\n\r\n/**\r\n * 動画設定・品質・URL構築を管理するクラス\r\n */\r\nexport class VideoConfigManager {\r\n    private container: HTMLElement;\r\n    private iframe: HTMLIFrameElement;\r\n    private config: TurntableConfig;\r\n\r\n    constructor(container: HTMLElement, iframe: HTMLIFrameElement, config: TurntableConfig) {\r\n        this.container = container;\r\n        this.iframe = iframe;\r\n        this.config = config;\r\n    }\r\n\r\n    /**\r\n     * 表示サイズに基づいてPIXELS_PER_ROTATIONを動的に計算\r\n     */\r\n    calculatePixelsPerRotation(): number {\r\n        const htmlWidth = parseInt(this.iframe.getAttribute('width') || '0');\r\n        const containerWidth = this.container.clientWidth || 0;\r\n        const iframeWidth = this.iframe.clientWidth || 0;\r\n        const computedWidth = Math.max(containerWidth, iframeWidth) || 0;\r\n\r\n        const finalWidth = htmlWidth || computedWidth || 320;\r\n\r\n        console.log(`Container width for calculation: ${finalWidth}px (html: ${htmlWidth}, container: ${containerWidth}, iframe: ${iframeWidth})`);\r\n\r\n        const basePixels = 1200;\r\n        const baseScreenSize = 640;\r\n\r\n        let pixelsPerRotation = (finalWidth / baseScreenSize) * basePixels;\r\n\r\n        if (finalWidth <= 480) {\r\n            pixelsPerRotation *= 1.2;\r\n        }\r\n\r\n        pixelsPerRotation = Math.max(250, Math.min(3000, pixelsPerRotation));\r\n\r\n        console.log(`Calculated PIXELS_PER_ROTATION: ${Math.round(pixelsPerRotation)} for width: ${finalWidth}px`);\r\n        return Math.round(pixelsPerRotation);\r\n    }\r\n\r\n    /**\r\n     * 表示サイズに応じた動画品質選択\r\n     */\r\n    selectVideoQuality(): string {\r\n        const videoWidth = parseInt(this.container.getAttribute('video-width') || '0');\r\n        const videoHeight = parseInt(this.container.getAttribute('video-height') || '0');\r\n        const htmlWidth = parseInt(this.iframe.getAttribute('width') || '0');\r\n        const htmlHeight = parseInt(this.iframe.getAttribute('height') || '0');\r\n        const computedWidth = this.iframe.clientWidth || this.container.clientWidth || 0;\r\n        const computedHeight = this.iframe.clientHeight || this.container.clientHeight || 0;\r\n\r\n        const finalWidth = videoWidth || htmlWidth || computedWidth || 480;\r\n        const finalHeight = videoHeight || htmlHeight || finalWidth;\r\n\r\n        const area = finalWidth * finalHeight;\r\n        const effectiveArea = Math.sqrt(area);\r\n\r\n        const devicePixelRatio = window.devicePixelRatio || 1;\r\n\r\n        let effectiveSize;\r\n        if ((htmlWidth && htmlHeight) || (videoWidth && videoHeight)) {\r\n            const limitedDPR = Math.min(devicePixelRatio, 1.5);\r\n            effectiveSize = effectiveArea * limitedDPR;\r\n        } else {\r\n            effectiveSize = effectiveArea * devicePixelRatio;\r\n        }\r\n\r\n        let selectedQuality = '240p';\r\n        if (effectiveSize <= 240) {\r\n            selectedQuality = '240p';\r\n        } else if (effectiveSize <= 360) {\r\n            selectedQuality = '360p';\r\n        } else if (effectiveSize <= 480) {\r\n            selectedQuality = '540p';\r\n        } else if (effectiveSize <= 960) {\r\n            selectedQuality = '720p';\r\n        } else if (effectiveSize <= 1280) {\r\n            selectedQuality = '1080p';\r\n        } else if (effectiveSize <= 1920) {\r\n            selectedQuality = '2k';\r\n        } else {\r\n            selectedQuality = '4k';\r\n        }\r\n\r\n        console.log(`Selected quality: ${selectedQuality} for effective size: ${effectiveSize}px (${finalWidth}x${finalHeight})`);\r\n        return selectedQuality;\r\n    }\r\n\r\n    /**\r\n     * 動画URLを構築\r\n     */\r\n    buildVideoUrl(): string {\r\n        const quality = this.selectVideoQuality();\r\n\r\n        const videoWidth = parseInt(this.container.getAttribute('video-width') || '0');\r\n        const videoHeight = parseInt(this.container.getAttribute('video-height') || '0');\r\n        const htmlWidth = parseInt(this.iframe.getAttribute('width') || '0');\r\n        const htmlHeight = parseInt(this.iframe.getAttribute('height') || '0');\r\n\r\n        let finalWidth = videoWidth || htmlWidth || 480;\r\n        let finalHeight = videoHeight || htmlHeight || finalWidth;\r\n\r\n        const screenWidth = window.innerWidth || document.documentElement.clientWidth;\r\n        if (screenWidth <= 768) {\r\n            const containerWidth = this.container.clientWidth || this.container.parentElement?.clientWidth || screenWidth;\r\n            const availableWidth = Math.floor(containerWidth * 0.9);\r\n            if (availableWidth > 200) {\r\n                finalWidth = availableWidth;\r\n                finalHeight = availableWidth;\r\n            }\r\n        }\r\n\r\n        this.iframe.setAttribute('width', finalWidth.toString());\r\n        this.iframe.setAttribute('height', finalHeight.toString());\r\n\r\n        if (screenWidth <= 768) {\r\n            this.iframe.style.width = finalWidth + 'px';\r\n            this.iframe.style.height = finalHeight + 'px';\r\n            this.iframe.style.maxWidth = 'none';\r\n            this.iframe.style.display = 'block';\r\n            console.log(`Applied direct CSS styles: ${finalWidth}x${finalHeight}`);\r\n        }\r\n\r\n        const params = new URLSearchParams({\r\n            background: '1',\r\n            byline: '0',\r\n            portrait: '0',\r\n            title: '0',\r\n            speed: '0',\r\n            transparent: '1',\r\n            gesture: 'media',\r\n            autopause: '0',\r\n            muted: '1',\r\n            loop: '1',\r\n            controls: '0',\r\n            quality: quality,\r\n            responsive: '0',\r\n            dnt: '1'\r\n        });\r\n\r\n        const url = `https://player.vimeo.com/video/${this.config.videoId}?${params.toString()}`;\r\n        console.log(`Video URL set: ${url} (Size: ${finalWidth}x${finalHeight}, Screen: ${screenWidth})`);\r\n        return url;\r\n    }\r\n\r\n    /**\r\n     * Vimeo oEmbed APIから動画情報を事前取得\r\n     */\r\n    async getVideoInfoFromAPI(): Promise<VideoInfo> {\r\n        try {\r\n            if (!/^\\d+$/.test(this.config.videoId)) {\r\n                throw new Error('Invalid video ID format for API call');\r\n            }\r\n\r\n            const oembedUrl = `https://vimeo.com/api/oembed.json?url=https://vimeo.com/${this.config.videoId}`;\r\n            console.log(`Fetching video info from: ${oembedUrl}`);\r\n\r\n            await delay(Math.random() * 500);\r\n\r\n            const controller = new AbortController();\r\n            const timeoutId = setTimeout(() => controller.abort(), 10000);\r\n\r\n            const response = await fetch(oembedUrl, {\r\n                signal: controller.signal,\r\n                referrerPolicy: 'no-referrer',\r\n                headers: {\r\n                    'Accept': 'application/json'\r\n                }\r\n            });\r\n\r\n            clearTimeout(timeoutId);\r\n\r\n            if (!response.ok) {\r\n                if (response.status === 404) {\r\n                    throw new Error(`Video not found (ID: ${this.config.videoId}). Please check the video ID.`);\r\n                } else if (response.status === 403) {\r\n                    throw new Error(`Access denied to video (ID: ${this.config.videoId}). Video may be private.`);\r\n                } else if (response.status >= 500) {\r\n                    throw new Error(`Vimeo server error (status: ${response.status}). Please try again later.`);\r\n                } else {\r\n                    throw new Error(`HTTP error! status: ${response.status}`);\r\n                }\r\n            }\r\n\r\n            const data = await response.json();\r\n\r\n            if (!data || typeof data !== 'object') {\r\n                throw new Error('Invalid API response format');\r\n            }\r\n\r\n            if (!data.width || !data.height || data.width <= 0 || data.height <= 0) {\r\n                throw new Error('Invalid video dimensions in API response');\r\n            }\r\n\r\n            const aspectRatio = data.height / data.width;\r\n\r\n            console.log(`API Video dimensions: ${data.width}x${data.height}, aspect ratio: ${aspectRatio.toFixed(3)}`);\r\n\r\n            return {\r\n                width: data.width,\r\n                height: data.height,\r\n                aspectRatio: aspectRatio,\r\n                title: data.title || 'Untitled Video'\r\n            };\r\n        } catch (error) {\r\n            if ((error as any).name === 'AbortError') {\r\n                console.warn('API request timed out, using default aspect ratio');\r\n            } else {\r\n                console.warn('Could not fetch video info from API:', getErrorMessage(error));\r\n            }\r\n\r\n            return {\r\n                width: 1920,\r\n                height: 1080,\r\n                aspectRatio: 9 / 16,\r\n                title: 'Untitled Video'\r\n            };\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 初期サイズを設定（API情報から）\r\n     */\r\n    async setInitialSizeFromAPI(\r\n        onProgress?: (progress: number, message: string) => void,\r\n        onAdjustOverlay?: () => void\r\n    ): Promise<void> {\r\n        try {\r\n            const currentWidth = parseInt(this.iframe.getAttribute('width') || '0');\r\n            const currentHeight = parseInt(this.iframe.getAttribute('height') || '0');\r\n\r\n            this.iframe.style.visibility = 'hidden';\r\n\r\n            if (currentWidth && currentHeight) {\r\n                console.log(`Both width and height specified: ${currentWidth}x${currentHeight}`);\r\n                this.container.classList.add('initialized');\r\n                this.iframe.style.visibility = 'visible';\r\n                this.iframe.classList.add('size-ready');\r\n                console.log('Container and iframe ready with fixed size');\r\n                onAdjustOverlay?.();\r\n                return;\r\n            }\r\n\r\n            if (currentWidth || currentHeight) {\r\n                onProgress?.(5, 'Getting video information...');\r\n\r\n                const videoInfo = await this.getVideoInfoFromAPI();\r\n\r\n                if (currentWidth && !currentHeight) {\r\n                    const calculatedHeight = Math.round(currentWidth * videoInfo.aspectRatio);\r\n                    this.iframe.setAttribute('height', calculatedHeight.toString());\r\n                    console.log(`Set height from width: ${currentWidth}x${calculatedHeight} (aspect ratio: ${videoInfo.aspectRatio.toFixed(3)})`);\r\n                } else if (currentHeight && !currentWidth) {\r\n                    const calculatedWidth = Math.round(currentHeight / videoInfo.aspectRatio);\r\n                    this.iframe.setAttribute('width', calculatedWidth.toString());\r\n                    console.log(`Set width from height: ${calculatedWidth}x${currentHeight} (aspect ratio: ${videoInfo.aspectRatio.toFixed(3)})`);\r\n                }\r\n\r\n                this.container.classList.add('initialized');\r\n                this.iframe.style.visibility = 'visible';\r\n                this.iframe.classList.add('size-ready');\r\n                console.log('Container and iframe size ready, made visible');\r\n\r\n                onAdjustOverlay?.();\r\n            } else {\r\n                const defaultWidth = 480;\r\n                onProgress?.(5, 'Getting video information...');\r\n\r\n                const videoInfo = await this.getVideoInfoFromAPI();\r\n                const calculatedHeight = Math.round(defaultWidth * videoInfo.aspectRatio);\r\n\r\n                this.iframe.setAttribute('width', defaultWidth.toString());\r\n                this.iframe.setAttribute('height', calculatedHeight.toString());\r\n                console.log(`Set default size: ${defaultWidth}x${calculatedHeight} (aspect ratio: ${videoInfo.aspectRatio.toFixed(3)})`);\r\n\r\n                this.container.classList.add('initialized');\r\n                this.iframe.style.visibility = 'visible';\r\n                this.iframe.classList.add('size-ready');\r\n                console.log('Container and iframe size ready with default size');\r\n\r\n                onAdjustOverlay?.();\r\n            }\r\n\r\n            console.log('setInitialSizeFromAPI completed');\r\n        } catch (error) {\r\n            console.warn('Could not set initial size from API:', error);\r\n            this.setInitialSizeFallback(onAdjustOverlay);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 初期サイズを設定（フォールバック版）\r\n     */\r\n    setInitialSizeFallback(onAdjustOverlay?: () => void): void {\r\n        try {\r\n            const currentWidth = parseInt(this.iframe.getAttribute('width') || '0');\r\n            const currentHeight = parseInt(this.iframe.getAttribute('height') || '0');\r\n\r\n            if (currentWidth && currentHeight) {\r\n                console.log(`Fallback: Both width and height specified: ${currentWidth}x${currentHeight}`);\r\n            } else if (currentWidth && !currentHeight) {\r\n                const defaultHeight = Math.round(currentWidth * (9 / 16));\r\n                this.iframe.setAttribute('height', defaultHeight.toString());\r\n                console.log(`Fallback: Set height from width: ${currentWidth}x${defaultHeight} (16:9 default aspect ratio)`);\r\n            } else if (currentHeight && !currentWidth) {\r\n                const defaultWidth = Math.round(currentHeight / (9 / 16));\r\n                this.iframe.setAttribute('width', defaultWidth.toString());\r\n                console.log(`Fallback: Set width from height: ${defaultWidth}x${currentHeight} (16:9 default aspect ratio)`);\r\n            } else {\r\n                const defaultWidth = 480;\r\n                const defaultHeight = Math.round(defaultWidth * (9 / 16));\r\n                this.iframe.setAttribute('width', defaultWidth.toString());\r\n                this.iframe.setAttribute('height', defaultHeight.toString());\r\n                console.log(`Fallback: Set default size: ${defaultWidth}x${defaultHeight} (16:9 default aspect ratio)`);\r\n            }\r\n\r\n            this.container.classList.add('initialized');\r\n            this.iframe.style.visibility = 'visible';\r\n            this.iframe.classList.add('size-ready');\r\n            console.log('Container and iframe size ready (fallback), made visible');\r\n\r\n            onAdjustOverlay?.();\r\n        } catch (error) {\r\n            console.warn('Could not set fallback initial size:', error);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 動画プレイヤーのセットアップ\r\n     */\r\n    setupVideoPlayer(): void {\r\n        const videoUrl = this.buildVideoUrl();\r\n        this.iframe.src = videoUrl;\r\n    }\r\n}\r\n","import type { TurntableState } from './types';\r\nimport { getErrorMessage, withTimeout, delay } from './utils';\r\n\r\n/**\r\n * プレイヤー初期化と事前ロードを管理するクラス\r\n */\r\nexport class PlayerInitializer {\r\n    private iframe: HTMLIFrameElement;\r\n    private container: HTMLElement;\r\n\r\n    constructor(container: HTMLElement, iframe: HTMLIFrameElement) {\r\n        this.container = container;\r\n        this.iframe = iframe;\r\n    }\r\n\r\n    /**\r\n     * Vimeoプレイヤーを作成\r\n     */\r\n    async createPlayer(onProgress?: (progress: number, message: string) => void): Promise<any> {\r\n        try {\r\n            onProgress?.(40, 'Connecting to player...');\r\n            // @ts-ignore - VimeoはグローバルにCDNから読み込まれている\r\n            const player = new Vimeo.Player(this.iframe);\r\n            return player;\r\n        } catch (error) {\r\n            throw new Error(`Failed to create Vimeo player: ${getErrorMessage(error)}`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * プレイヤーの基本情報取得\r\n     */\r\n    async getPlayerDuration(player: any, isReloading: boolean = false, onProgress?: (progress: number, message: string) => void): Promise<number> {\r\n        onProgress?.(60, 'Loading player settings...');\r\n\r\n        // リロード時はタイムアウトを長くする\r\n        const timeout = isReloading ? 15000 : 10000;\r\n        const duration = await withTimeout(\r\n            player.getDuration(),\r\n            timeout,\r\n            'Failed to get video duration'\r\n        );\r\n        console.log('Duration:', duration);\r\n\r\n        if (!duration || duration <= 0) {\r\n            throw new Error('Invalid video duration received');\r\n        }\r\n\r\n        return duration;\r\n    }\r\n\r\n    /**\r\n     * 動画のアスペクト比を調整（プレイヤー情報から詳細確認）\r\n     */\r\n    async adjustVideoAspectRatio(player: any, onAdjustOverlay?: () => void): Promise<void> {\r\n        try {\r\n            console.log('Getting video dimensions...');\r\n            const videoWidth = await withTimeout(\r\n                player.getVideoWidth(),\r\n                3000,\r\n                'Failed to get video width'\r\n            );\r\n            const videoHeight = await withTimeout(\r\n                player.getVideoHeight(),\r\n                3000,\r\n                'Failed to get video height'\r\n            );\r\n            const aspectRatio = videoHeight / videoWidth;\r\n\r\n            console.log(`Player Video dimensions: ${videoWidth}x${videoHeight}, aspect ratio: ${aspectRatio.toFixed(3)}`);\r\n\r\n            const currentWidth = parseInt(this.iframe.getAttribute('width') || '480');\r\n            const currentHeight = parseInt(this.iframe.getAttribute('height') || '480');\r\n            const currentAspectRatio = currentHeight / currentWidth;\r\n            const specifiedVideoHeight = parseInt(this.container.getAttribute('video-height') || '0');\r\n\r\n            if (!specifiedVideoHeight && Math.abs(currentAspectRatio - aspectRatio) > 0.01) {\r\n                const calculatedHeight = Math.round(currentWidth * aspectRatio);\r\n                this.iframe.setAttribute('height', calculatedHeight.toString());\r\n                console.log(`Fine-tuned iframe size: ${currentWidth}x${calculatedHeight} (aspect ratio: ${aspectRatio.toFixed(3)})`);\r\n\r\n                onAdjustOverlay?.();\r\n            } else {\r\n                console.log('Aspect ratio already correct, no adjustment needed');\r\n            }\r\n        } catch (error) {\r\n            console.warn('Could not get video dimensions, keeping current size:', getErrorMessage(error));\r\n            onAdjustOverlay?.();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * プレイヤー設定を個別にエラーハンドリング付きで適用\r\n     */\r\n    async applyPlayerSettings(player: any, onProgress?: (progress: number, message: string) => void): Promise<void> {\r\n        onProgress?.(75, 'Applying player settings...');\r\n\r\n        const settings = [\r\n            {\r\n                name: 'loop',\r\n                action: () => player.setLoop(true),\r\n                fallback: () => console.warn('Could not set loop mode')\r\n            },\r\n            {\r\n                name: 'volume',\r\n                action: () => player.setVolume(0),\r\n                fallback: () => console.warn('Could not set volume')\r\n            }\r\n        ];\r\n\r\n        for (const setting of settings) {\r\n            try {\r\n                await withTimeout(setting.action(), 3000, `Failed to set ${setting.name}`);\r\n                console.log(`Successfully set ${setting.name}`);\r\n            } catch (error) {\r\n                console.warn(`Setting ${setting.name} failed:`, getErrorMessage(error));\r\n                setting.fallback();\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 動画の事前ロード（失敗しても続行可能）\r\n     */\r\n    async preloadVideo(player: any, duration: number, onProgress?: (progress: number, message: string) => void): Promise<boolean> {\r\n        try {\r\n            onProgress?.(85, 'Buffering video...');\r\n            console.log('Starting video buffer preload...');\r\n\r\n            // 再生せずにseekだけでバッファリング（ブラウザの自動再生ブロックを回避）\r\n            const preloadPoints = [0, 0.5];\r\n            for (let i = 0; i < preloadPoints.length; i++) {\r\n                const point = preloadPoints[i];\r\n                const seekTime = duration * point;\r\n                await withTimeout(\r\n                    player.setCurrentTime(seekTime),\r\n                    5000,\r\n                    `Preload seek timeout at ${point * 100}%`\r\n                );\r\n                await delay(300);\r\n\r\n                onProgress?.(85 + (i + 1) * 2, `Buffering ${Math.round(point * 100)}%...`);\r\n            }\r\n\r\n            await withTimeout(player.setCurrentTime(0), 5000, 'Preload final seek timeout');\r\n\r\n            console.log('Video buffer preload completed');\r\n            return true;\r\n        } catch (error) {\r\n            // バッファリングはオプショナルなので、失敗しても問題ない\r\n            console.log('Video buffer preload skipped:', getErrorMessage(error));\r\n            return false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 初期プレイヤー状態の設定\r\n     */\r\n    async setInitialPlayerState(player: any, onProgress?: (progress: number, message: string) => void): Promise<void> {\r\n        onProgress?.(90, 'Setting initial state...');\r\n\r\n        // playはブラウザの自動再生ポリシーでブロックされる可能性があるが、\r\n        // pauseとseekが成功すればウィジェットは機能する\r\n        const actions = [\r\n            { name: 'play', action: () => player.play(), optional: true },\r\n            { name: 'pause', action: () => player.pause(), optional: false },\r\n            { name: 'seek to start', action: () => player.setCurrentTime(0), optional: false }\r\n        ];\r\n\r\n        for (const action of actions) {\r\n            try {\r\n                await withTimeout(action.action(), 3000, `Failed to ${action.name}`);\r\n                console.log(`Successfully executed: ${action.name}`);\r\n            } catch (error) {\r\n                if (action.optional) {\r\n                    // オプショナルな操作（play等）の失敗は通常動作\r\n                    console.log(`${action.name} skipped (likely blocked by browser autoplay policy)`);\r\n                } else {\r\n                    // 必須の操作（pause/seek）の失敗は警告\r\n                    console.warn(`Action ${action.name} failed:`, getErrorMessage(error));\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n","import type { TurntableConfig, TurntableState } from './types';\r\n\r\n/**\r\n * ドラッグ操作とイベント処理を管理するクラス\r\n */\r\nexport class DragHandler {\r\n    private container: HTMLElement;\r\n    private dragOverlay: HTMLElement;\r\n    private state: TurntableState;\r\n    private config: TurntableConfig;\r\n    private calculatePixelsPerRotation: () => number;\r\n    private onAngleUpdate: (seconds: number) => void;\r\n\r\n    // バインド済みのイベントハンドラー\r\n    private boundMouseDown: (e: MouseEvent) => Promise<void>;\r\n    private boundMouseMove: (e: MouseEvent) => void;\r\n    private boundMouseUp: () => void;\r\n    private boundTouchStart: (e: TouchEvent) => Promise<void>;\r\n    private boundTouchMove: (e: TouchEvent) => void;\r\n    private boundTouchEnd: (e: TouchEvent) => void;\r\n\r\n    constructor(\r\n        container: HTMLElement,\r\n        dragOverlay: HTMLElement,\r\n        state: TurntableState,\r\n        config: TurntableConfig,\r\n        calculatePixelsPerRotation: () => number,\r\n        onAngleUpdate: (seconds: number) => void\r\n    ) {\r\n        this.container = container;\r\n        this.dragOverlay = dragOverlay;\r\n        this.state = state;\r\n        this.config = config;\r\n        this.calculatePixelsPerRotation = calculatePixelsPerRotation;\r\n        this.onAngleUpdate = onAngleUpdate;\r\n\r\n        // イベントハンドラーをバインド\r\n        this.boundMouseDown = this.onMouseDown.bind(this);\r\n        this.boundMouseMove = this.onMouseMove.bind(this);\r\n        this.boundMouseUp = this.onMouseUp.bind(this);\r\n        this.boundTouchStart = this.onTouchStart.bind(this);\r\n        this.boundTouchMove = this.onTouchMove.bind(this);\r\n        this.boundTouchEnd = this.onTouchEnd.bind(this);\r\n    }\r\n\r\n    /**\r\n     * イベントリスナーを追加\r\n     */\r\n    attachEventListeners(): void {\r\n        this.dragOverlay.addEventListener('mousedown', this.boundMouseDown);\r\n        this.dragOverlay.addEventListener('touchstart', this.boundTouchStart, { passive: false });\r\n    }\r\n\r\n    /**\r\n     * イベントリスナーを削除\r\n     */\r\n    removeEventListeners(): void {\r\n        this.dragOverlay.removeEventListener('mousedown', this.boundMouseDown);\r\n        this.dragOverlay.removeEventListener('touchstart', this.boundTouchStart);\r\n        document.removeEventListener('mousemove', this.boundMouseMove);\r\n        document.removeEventListener('mouseup', this.boundMouseUp);\r\n        document.removeEventListener('touchmove', this.boundTouchMove);\r\n        document.removeEventListener('touchend', this.boundTouchEnd);\r\n    }\r\n\r\n    /**\r\n     * 新しい再生時間を計算（ループ対応）\r\n     */\r\n    private calculateNewTime(deltaX: number): number {\r\n        const sensitivityFactor = 0.9;\r\n        const pixelsPerRotation = this.calculatePixelsPerRotation();\r\n        const adjustedDelta = deltaX * sensitivityFactor;\r\n        const rotationProgress = adjustedDelta / pixelsPerRotation;\r\n\r\n        const timeDelta = this.config.isClockwise\r\n            ? -rotationProgress * this.state.duration\r\n            : rotationProgress * this.state.duration;\r\n\r\n        let newTime = this.state.startTime + timeDelta;\r\n\r\n        return ((newTime % this.state.duration) + this.state.duration) % this.state.duration;\r\n    }\r\n\r\n    /**\r\n     * ドラッグ操作の共通処理\r\n     */\r\n    private handleDragMove(currentX: number): void {\r\n        if (!this.state.isDragging || !this.state.isPlayerReady) return;\r\n\r\n        if (this.state.startTime === undefined || this.state.startTime === null) return;\r\n        if (this.state.dragStartX === undefined || this.state.dragStartX === null) return;\r\n\r\n        const deltaX = currentX - this.state.dragStartX;\r\n\r\n        if (Math.abs(deltaX) > 2000) {\r\n            console.warn('Extreme deltaX detected, ignoring:', deltaX);\r\n            return;\r\n        }\r\n\r\n        const newTime = this.calculateNewTime(deltaX);\r\n\r\n        // UI更新を即座に実行\r\n        this.onAngleUpdate(newTime);\r\n\r\n        const now = performance.now();\r\n        const shouldThrottle = now - this.state.lastDragUpdate < 100;\r\n\r\n        if (!shouldThrottle) {\r\n            this.state.lastDragUpdate = now;\r\n\r\n            if (this.state.pendingApiCall) {\r\n                cancelAnimationFrame(this.state.pendingApiCall);\r\n            }\r\n\r\n            this.state.pendingApiCall = requestAnimationFrame(() => {\r\n                if (this.state.isDragging && this.state.isPlayerReady) {\r\n                    this.state.player?.setCurrentTime(newTime).catch((err: any) => {\r\n                        console.warn('Vimeo API call ignored due to performance:', err);\r\n                    });\r\n                }\r\n                this.state.pendingApiCall = null;\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * ドラッグ開始の共通処理\r\n     */\r\n    private async handleDragStart(startX: number): Promise<boolean> {\r\n        if (!this.state.isPlayerReady) return false;\r\n\r\n        this.state.isDragging = false;\r\n        this.state.dragStartX = startX;\r\n        this.dragOverlay.style.cursor = 'grabbing';\r\n\r\n        try {\r\n            this.state.startTime = await this.state.player.getCurrentTime();\r\n            this.state.isDragging = true;\r\n\r\n            this.dragOverlay.classList.add('dragging');\r\n            this.container.classList.add('dragging');\r\n\r\n            this.state.dragStartX = startX;\r\n\r\n            console.log('Drag started at time:', this.state.startTime, 'position:', startX);\r\n            return true;\r\n        } catch (error) {\r\n            console.error('Failed to get current time:', error);\r\n            this.state.isDragging = false;\r\n            this.dragOverlay.classList.remove('dragging');\r\n            this.container.classList.remove('dragging');\r\n            this.dragOverlay.style.cursor = 'grab';\r\n            return false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * ドラッグ終了の共通処理\r\n     */\r\n    private handleDragEnd(): void {\r\n        if (!this.state.isDragging) return;\r\n\r\n        this.state.isDragging = false;\r\n\r\n        this.dragOverlay.classList.remove('dragging');\r\n        this.container.classList.remove('dragging');\r\n\r\n        if (this.state.pendingApiCall) {\r\n            cancelAnimationFrame(this.state.pendingApiCall);\r\n            this.state.pendingApiCall = null;\r\n        }\r\n\r\n        this.dragOverlay.style.cursor = 'grab';\r\n        this.state.player?.pause();\r\n    }\r\n\r\n    /**\r\n     * マウスダウンイベントハンドラー\r\n     */\r\n    private async onMouseDown(e: MouseEvent): Promise<void> {\r\n        if (this.state.isDragging) return;\r\n\r\n        const success = await this.handleDragStart(e.clientX);\r\n        if (!success) return;\r\n\r\n        document.addEventListener('mousemove', this.boundMouseMove);\r\n        document.addEventListener('mouseup', this.boundMouseUp);\r\n        e.preventDefault();\r\n    }\r\n\r\n    /**\r\n     * マウスムーブイベントハンドラー\r\n     */\r\n    private onMouseMove(e: MouseEvent): void {\r\n        this.handleDragMove(e.clientX);\r\n    }\r\n\r\n    /**\r\n     * マウスアップイベントハンドラー\r\n     */\r\n    private onMouseUp(): void {\r\n        this.handleDragEnd();\r\n        document.removeEventListener('mousemove', this.boundMouseMove);\r\n        document.removeEventListener('mouseup', this.boundMouseUp);\r\n    }\r\n\r\n    /**\r\n     * タッチスタートイベントハンドラー\r\n     */\r\n    private async onTouchStart(e: TouchEvent): Promise<void> {\r\n        if (this.state.isDragging) return;\r\n\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n\r\n        const success = await this.handleDragStart(e.touches[0].clientX);\r\n        if (!success) return;\r\n\r\n        document.addEventListener('touchmove', this.boundTouchMove, { passive: false });\r\n        document.addEventListener('touchend', this.boundTouchEnd, { passive: false });\r\n    }\r\n\r\n    /**\r\n     * タッチムーブイベントハンドラー\r\n     */\r\n    private onTouchMove(e: TouchEvent): void {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n\r\n        this.handleDragMove(e.touches[0].clientX);\r\n    }\r\n\r\n    /**\r\n     * タッチエンドイベントハンドラー\r\n     */\r\n    private onTouchEnd(e: TouchEvent): void {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n\r\n        this.handleDragEnd();\r\n        document.removeEventListener('touchmove', this.boundTouchMove);\r\n        document.removeEventListener('touchend', this.boundTouchEnd);\r\n    }\r\n}\r\n","import type { TurntableConfig, TurntableState } from './types';\r\nimport { ProgressManager } from './progress-manager';\r\n\r\n/**\r\n * UI更新を管理するクラス（角度表示、リロードボタン、Vimeoリンク）\r\n */\r\nexport class UIManager {\r\n    private container: HTMLElement;\r\n    private iframe: HTMLIFrameElement;\r\n    private angleEl: HTMLElement | null;\r\n    private angleDisplay: HTMLElement | null;\r\n    private reloadButton: HTMLButtonElement;\r\n    private config: TurntableConfig;\r\n    private state: TurntableState;\r\n    private progressManager: ProgressManager;\r\n    private onReload: () => Promise<void>;\r\n\r\n    constructor(\r\n        container: HTMLElement,\r\n        iframe: HTMLIFrameElement,\r\n        angleEl: HTMLElement | null,\r\n        angleDisplay: HTMLElement | null,\r\n        config: TurntableConfig,\r\n        state: TurntableState,\r\n        progressManager: ProgressManager,\r\n        onReload: () => Promise<void>\r\n    ) {\r\n        this.container = container;\r\n        this.iframe = iframe;\r\n        this.angleEl = angleEl;\r\n        this.angleDisplay = angleDisplay;\r\n        this.config = config;\r\n        this.state = state;\r\n        this.progressManager = progressManager;\r\n        this.onReload = onReload;\r\n\r\n        // リロードボタンを作成\r\n        this.reloadButton = document.createElement('button');\r\n        this.createReloadButton();\r\n    }\r\n\r\n    /**\r\n     * リロードボタンを作成\r\n     */\r\n    private createReloadButton(): void {\r\n        this.reloadButton.className = 'reload-button';\r\n        this.reloadButton.title = 'ビデオを再読み込み';\r\n\r\n        this.reloadButton.innerHTML = `\r\n            <svg class=\"reload-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\r\n                <path d=\"M23 4v6h-6\"/>\r\n                <path d=\"M20.49 15a9 9 0 1 1-2.12-9.36L23 10\"/>\r\n            </svg>\r\n        `;\r\n\r\n        this.reloadButton.addEventListener('click', () => {\r\n            this.onReload();\r\n        });\r\n\r\n        this.container.appendChild(this.reloadButton);\r\n    }\r\n\r\n    /**\r\n     * リロードボタンを表示\r\n     */\r\n    showReloadButton(): void {\r\n        if (this.reloadButton) {\r\n            this.reloadButton.style.display = 'flex';\r\n        }\r\n    }\r\n\r\n    /**\r\n     * リロードボタンを非表示\r\n     */\r\n    hideReloadButton(): void {\r\n        if (this.reloadButton) {\r\n            this.reloadButton.style.display = 'none';\r\n        }\r\n    }\r\n\r\n    /**\r\n     * リロード処理のローディング状態を設定\r\n     */\r\n    setReloadLoading(isLoading: boolean): void {\r\n        if (isLoading) {\r\n            this.reloadButton.classList.add('loading');\r\n        } else {\r\n            this.reloadButton.classList.remove('loading');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 角度表示更新\r\n     */\r\n    updateAngle(seconds: number): void {\r\n        let angle;\r\n\r\n        if (this.config.isClockwise) {\r\n            angle = (seconds / this.state.duration) * 360;\r\n        } else {\r\n            angle = 360 - (seconds / this.state.duration) * 360;\r\n        }\r\n\r\n        angle = angle % 360;\r\n        if (angle < 0) angle += 360;\r\n\r\n        if (!this.angleEl) return;\r\n\r\n        const roundedAngle = Math.round(angle);\r\n        if (this.state.isDragging) {\r\n            this.angleEl.textContent = roundedAngle.toString();\r\n            this.state.lastDisplayedAngle = roundedAngle;\r\n        } else {\r\n            if (this.state.lastDisplayedAngle !== roundedAngle) {\r\n                this.angleEl.textContent = roundedAngle.toString();\r\n                this.state.lastDisplayedAngle = roundedAngle;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 角度表示の位置を調整\r\n     */\r\n    adjustAngleDisplayPosition(): void {\r\n        if (!this.angleDisplay || !this.iframe) {\r\n            console.log('angleDisplay or iframe not found, skipping position adjustment');\r\n            return;\r\n        }\r\n\r\n        const wasHidden = this.angleDisplay.style.display === 'none';\r\n        if (wasHidden) {\r\n            this.angleDisplay.style.visibility = 'hidden';\r\n            this.angleDisplay.style.display = 'block';\r\n        }\r\n\r\n        console.log('Angle display positioned at bottom center via CSS');\r\n\r\n        if (wasHidden) {\r\n            this.angleDisplay.style.display = 'none';\r\n            this.angleDisplay.style.visibility = 'visible';\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 角度表示を表示\r\n     */\r\n    showAngleDisplay(): void {\r\n        if (this.angleDisplay && this.config.showAngle) {\r\n            this.adjustAngleDisplayPosition();\r\n            this.angleDisplay.style.display = 'block';\r\n            console.log('Angle display enabled after successful initialization and position adjustment');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 角度表示を非表示\r\n     */\r\n    hideAngleDisplay(): void {\r\n        if (this.angleDisplay) {\r\n            this.angleDisplay.style.display = 'none';\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Vimeoリンクを表示\r\n     */\r\n    showVimeoLink(): void {\r\n        const vimeoLink = (this.container.parentNode?.querySelector('.vimeo-link') ||\r\n            this.container.querySelector('.vimeo-link')) as HTMLAnchorElement;\r\n        if (vimeoLink && this.config.videoId) {\r\n            if (!/^\\d+$/.test(this.config.videoId)) {\r\n                console.warn('Invalid video ID format detected, skipping Vimeo link generation');\r\n                return;\r\n            }\r\n\r\n            vimeoLink.href = `https://vimeo.com/${this.config.videoId}`;\r\n\r\n            if (this.iframe) {\r\n                const videoWidth = this.iframe.offsetWidth;\r\n                if (videoWidth > 0) {\r\n                    vimeoLink.style.width = `${videoWidth}px`;\r\n                    console.log(`Vimeo link width adjusted to ${videoWidth}px`);\r\n                }\r\n            }\r\n\r\n            vimeoLink.classList.add('visible');\r\n            console.log('Vimeo link displayed');\r\n        } else if (!vimeoLink) {\r\n            console.log('Vimeo link element not found (optional element)');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * ローディングオーバーレイを隠す（UI調整含む）\r\n     */\r\n    hideLoadingOverlay(): void {\r\n        this.progressManager.hideLoadingOverlay();\r\n\r\n        if (this.angleDisplay) {\r\n            this.adjustAngleDisplayPosition();\r\n        }\r\n\r\n        this.showVimeoLink();\r\n    }\r\n\r\n    /**\r\n     * エラー表示\r\n     */\r\n    showError(title: string, message: string): void {\r\n        this.progressManager.showError(title, message);\r\n    }\r\n}\r\n","// CSSをインポート\r\nimport './turntable-viewer.css';\r\nimport type { TurntableConfig, TurntableState } from './types';\r\nimport { ProgressManager } from './progress-manager';\r\nimport { VideoConfigManager } from './video-config-manager';\r\nimport { PlayerInitializer } from './player-initializer';\r\nimport { DragHandler } from './drag-handler';\r\nimport { UIManager } from './ui-manager';\r\nimport { getErrorMessage, delay } from './utils';\r\n\r\n/**\r\n * Web Turntable Viewer\r\n * ドラッグ操作で360度回転表示を制御するクラス\r\n */\r\nexport class TurntableViewer {\r\n    private container: HTMLElement;\r\n    private iframe: HTMLIFrameElement;\r\n    private dragOverlay: HTMLElement;\r\n    private config: TurntableConfig;\r\n    private state: TurntableState;\r\n    private isReloading: boolean = false;\r\n    private root: Document | ShadowRoot;\r\n\r\n    // マネージャークラス\r\n    private progressManager: ProgressManager;\r\n    private videoConfigManager: VideoConfigManager;\r\n    private playerInitializer: PlayerInitializer;\r\n    private dragHandler: DragHandler | null = null;\r\n    private uiManager: UIManager;\r\n\r\n    constructor(containerId: string, root: Document | ShadowRoot = document) {\r\n        // DOM要素の取得（Shadow DOM対応）\r\n        this.root = root;\r\n        const container = this.root.getElementById(containerId);\r\n        if (!container) {\r\n            throw new Error(`Container element with id \"${containerId}\" not found`);\r\n        }\r\n        this.container = container;\r\n\r\n        const iframe = this.container.querySelector<HTMLIFrameElement>('iframe');\r\n        if (!iframe) {\r\n            throw new Error('iframe element not found in container');\r\n        }\r\n        this.iframe = iframe;\r\n\r\n        const angleEl = this.container.querySelector<HTMLElement>('#rotation-angle');\r\n        const angleDisplay = this.container.querySelector<HTMLElement>('#angle-display');\r\n\r\n        const dragOverlay = this.container.querySelector<HTMLElement>('.drag-overlay');\r\n        if (!dragOverlay) {\r\n            throw new Error('drag-overlay element not found in container');\r\n        }\r\n        this.dragOverlay = dragOverlay;\r\n\r\n        // プログレスバー関連要素\r\n        const loadingOverlay = this.container.querySelector<HTMLElement>('.loading-overlay');\r\n        const loadingText = this.container.querySelector<HTMLElement>('.loading-text');\r\n        const progressFill = this.container.querySelector<HTMLElement>('.progress-fill');\r\n        const progressText = this.container.querySelector<HTMLElement>('.progress-text');\r\n\r\n        if (!loadingOverlay || !loadingText || !progressFill || !progressText) {\r\n            throw new Error('Required loading elements not found in container');\r\n        }\r\n\r\n        // ProgressManagerを初期化\r\n        this.progressManager = new ProgressManager(\r\n            this.container,\r\n            this.iframe,\r\n            loadingOverlay,\r\n            loadingText,\r\n            progressFill,\r\n            progressText,\r\n            this.config\r\n        );\r\n\r\n        // DOM要素の存在確認\r\n        console.log('DOM elements check:');\r\n        console.log('- container:', !!this.container);\r\n        console.log('- iframe:', !!this.iframe);\r\n        console.log('- loadingOverlay:', !!loadingOverlay);\r\n        console.log('- progressFill:', !!progressFill);\r\n        console.log('- progressText:', !!progressText);\r\n        console.log('- loadingText:', !!loadingText);\r\n        console.log('- angleEl (optional):', !!angleEl);\r\n        console.log('- angleDisplay (optional):', !!angleDisplay);\r\n\r\n        // 必須要素のチェック\r\n        if (!this.container || !this.iframe || !loadingOverlay) {\r\n            throw new Error('Required elements not found: container, iframe, or loading-overlay');\r\n        }\r\n\r\n        console.log('DOM elements validation passed');\r\n\r\n        // 設定を取得\r\n        try {\r\n            this.config = this.getConfig();\r\n            console.log('Configuration loaded:', this.config);\r\n        } catch (error) {\r\n            const message = getErrorMessage(error);\r\n            console.error('Configuration error:', message);\r\n            this.showError('Configuration Error', message);\r\n            throw error;\r\n        }\r\n\r\n        // 状態管理\r\n        this.state = {\r\n            player: null,\r\n            duration: 0,\r\n            isPlayerReady: false,\r\n            isDragging: false,\r\n            dragStartX: 0,\r\n            startTime: 0,\r\n            lastDragUpdate: 0,\r\n            lastDisplayedAngle: null,\r\n            pendingApiCall: null\r\n        };\r\n\r\n        // マネージャークラスを初期化\r\n        this.videoConfigManager = new VideoConfigManager(this.container, this.iframe, this.config);\r\n        this.playerInitializer = new PlayerInitializer(this.container, this.iframe);\r\n        this.uiManager = new UIManager(\r\n            this.container,\r\n            this.iframe,\r\n            angleEl,\r\n            angleDisplay,\r\n            this.config,\r\n            this.state,\r\n            this.progressManager,\r\n            this.handleReload.bind(this)\r\n        );\r\n\r\n        // 初期化\r\n        this.initialize();\r\n    }\r\n\r\n    /**\r\n     * 設定を取得\r\n     */\r\n    getConfig(): TurntableConfig {\r\n        const videoId = this.container.getAttribute('vimeo-video-id');\r\n        const clockwiseAttr = this.container.getAttribute('clockwise-rotation');\r\n        let isClockwise = true; // デフォルトは時計回り\r\n\r\n        // clockwise-rotation属性が存在する場合のみチェック\r\n        if (clockwiseAttr !== null) {\r\n            // 属性値が空、\"true\"、\"1\" の場合は時計回り\r\n            if (clockwiseAttr === '' || clockwiseAttr === 'true' || clockwiseAttr === '1') {\r\n                isClockwise = true;\r\n            }\r\n            // 属性値が\"false\"、\"0\" の場合は反時計回り\r\n            else if (clockwiseAttr === 'false' || clockwiseAttr === '0') {\r\n                isClockwise = false;\r\n            }\r\n            // それ以外の値は無効としてデフォルトの時計回りを使用\r\n            else {\r\n                console.warn(`Invalid clockwise-rotation attribute value: \"${clockwiseAttr}\". Using default \"true\".`);\r\n                isClockwise = true;\r\n            }\r\n        }\r\n        // clockwise-rotation属性がない場合はデフォルトの時計回り\r\n\r\n        if (!videoId) {\r\n            throw new Error('vimeo-video-id attribute is required on the container element');\r\n        }\r\n\r\n        if (!/^\\d+$/.test(videoId)) {\r\n            throw new Error(`Invalid vimeo-video-id format: \"${videoId}\". Only numeric IDs are allowed.`);\r\n        }\r\n\r\n        return {\r\n            PLAYER_LOAD_DELAY_MS: 1000,\r\n            DRAG_THROTTLE_MS: 16,\r\n            isClockwise: isClockwise,\r\n            videoId: videoId,\r\n            showAngle: this.container.hasAttribute('show-angle')\r\n        };\r\n    }\r\n\r\n    /**\r\n     * 初期化\r\n     */\r\n    async initialize(): Promise<void> {\r\n        this.uiManager.hideAngleDisplay();\r\n        this.progressManager.showLoadingOverlay();\r\n\r\n        try {\r\n            await this.initializePlayer();\r\n            this.attachEventListeners();\r\n            console.log('TurntableViewer initialized successfully');\r\n\r\n            this.uiManager.showAngleDisplay();\r\n        } catch (error) {\r\n            console.error('TurntableViewer initialization failed:', error);\r\n            this.progressManager.updateProgress(100, '初期化エラーが発生しました');\r\n            this.uiManager.hideLoadingOverlay();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * リロード処理\r\n     */\r\n    async handleReload(): Promise<void> {\r\n        if (this.isReloading) return;\r\n\r\n        this.isReloading = true;\r\n        this.uiManager.setReloadLoading(true);\r\n\r\n        try {\r\n            console.log('Reloading turntable viewer...');\r\n\r\n            // DragHandlerのイベントリスナーを削除\r\n            if (this.dragHandler) {\r\n                this.dragHandler.removeEventListeners();\r\n                this.dragHandler = null;\r\n            }\r\n\r\n            // iframe情報をプレイヤー破棄前に保存（destroy が iframe を削除する可能性があるため）\r\n            if (!this.iframe || !this.iframe.parentElement) {\r\n                console.error('iframe or parent element not found, cannot reload');\r\n                throw new Error('Cannot reload: iframe element not properly initialized');\r\n            }\r\n\r\n            const parent = this.iframe.parentElement;\r\n            const oldId = this.iframe.id;\r\n            const oldClassName = this.iframe.className;\r\n            const oldWidth = this.iframe.getAttribute('width') || '';\r\n            const oldHeight = this.iframe.getAttribute('height') || '';\r\n\r\n            // プレイヤーを破棄\r\n            if (this.state.player) {\r\n                try {\r\n                    await this.state.player.destroy();\r\n                    console.log('Player destroyed successfully');\r\n                } catch (e) {\r\n                    console.warn('Error destroying player:', e);\r\n                }\r\n                this.state.player = null;\r\n            }\r\n\r\n            // 古いiframeを削除（既に destroy で削除されている可能性があるため確認）\r\n            if (this.iframe.parentElement) {\r\n                this.iframe.remove();\r\n                console.log('Old iframe removed');\r\n            } else {\r\n                console.log('iframe already removed by player.destroy()');\r\n            }\r\n\r\n            // 新しいiframe要素を作成\r\n            const newIframe = document.createElement('iframe');\r\n            newIframe.id = oldId;\r\n            newIframe.className = oldClassName;\r\n            newIframe.setAttribute('allow', 'autoplay; fullscreen; picture-in-picture');\r\n            newIframe.setAttribute('loading', 'lazy');\r\n\r\n            // サイズ属性を即座に設定してリサイズを防ぐ\r\n            if (oldWidth) newIframe.setAttribute('width', oldWidth);\r\n            if (oldHeight) newIframe.setAttribute('height', oldHeight);\r\n\r\n            // 新しいiframeを挿入\r\n            parent.appendChild(newIframe);\r\n            this.iframe = newIframe;\r\n            console.log('iframe element recreated with size:', oldWidth, 'x', oldHeight);\r\n\r\n            // マネージャークラスのiframe参照を更新\r\n            this.videoConfigManager = new VideoConfigManager(this.container, this.iframe, this.config);\r\n            this.playerInitializer = new PlayerInitializer(this.container, this.iframe);\r\n\r\n            // 少し待機してブラウザがDOMを更新するのを待つ\r\n            await delay(300);\r\n\r\n            // 状態をリセット\r\n            this.state = {\r\n                player: null,\r\n                duration: 0,\r\n                isPlayerReady: false,\r\n                isDragging: false,\r\n                startTime: 0,\r\n                dragStartX: 0,\r\n                lastDragUpdate: 0,\r\n                pendingApiCall: null,\r\n                lastDisplayedAngle: 0\r\n            };\r\n\r\n            this.progressManager.resetTimeout();\r\n\r\n            // 再初期化\r\n            await this.initialize();\r\n\r\n        } catch (error) {\r\n            console.error('Reload failed:', error);\r\n        } finally {\r\n            this.isReloading = false;\r\n            this.uiManager.setReloadLoading(false);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Vimeoプレイヤー初期化\r\n     */\r\n    async initializePlayer(): Promise<void> {\r\n        try {\r\n            // 初期サイズを設定\r\n            await this.videoConfigManager.setInitialSizeFromAPI(\r\n                (progress, message) => {\r\n                    this.progressManager.updateProgress(progress, message);\r\n                },\r\n                () => {\r\n                    this.progressManager.adjustLoadingOverlaySize();\r\n                }\r\n            );\r\n\r\n            // 動画URLを構築してiframeを設定\r\n            this.videoConfigManager.setupVideoPlayer();\r\n\r\n            this.progressManager.updateProgress(20, 'Creating player...');\r\n\r\n            // iframeが新しいURLをロードするまで待機（リロード時は長めに）\r\n            if (this.isReloading) {\r\n                await delay(2000);\r\n                console.log('Extended delay for reload');\r\n            } else {\r\n                await delay(this.config.PLAYER_LOAD_DELAY_MS);\r\n            }\r\n\r\n            // プレイヤーを作成\r\n            this.state.player = await this.playerInitializer.createPlayer((progress, message) => {\r\n                this.progressManager.updateProgress(progress, message);\r\n            });\r\n\r\n            // プレイヤーが完全にロードされるまで待機（リロード時はさらに長めに）\r\n            if (this.isReloading) {\r\n                await delay(2000);\r\n                console.log('Extended player load delay for reload');\r\n            } else {\r\n                await delay(this.config.PLAYER_LOAD_DELAY_MS);\r\n            }\r\n            this.progressManager.updateProgress(60, 'Loading player settings...');\r\n\r\n            // プレイヤーの基本情報取得\r\n            this.state.duration = await this.playerInitializer.getPlayerDuration(\r\n                this.state.player,\r\n                this.isReloading,\r\n                (progress, message) => this.progressManager.updateProgress(progress, message)\r\n            );\r\n\r\n            // 動画のアスペクト比を調整\r\n            await this.playerInitializer.adjustVideoAspectRatio(\r\n                this.state.player,\r\n                () => this.progressManager.adjustLoadingOverlaySize()\r\n            );\r\n\r\n            this.progressManager.updateProgress(75, 'Applying player settings...');\r\n\r\n            // プレイヤー設定を適用\r\n            await this.playerInitializer.applyPlayerSettings(this.state.player);\r\n\r\n            // 動画の事前バッファリング（オプショナル）\r\n            await this.playerInitializer.preloadVideo(\r\n                this.state.player,\r\n                this.state.duration,\r\n                (progress, message) => this.progressManager.updateProgress(progress, message)\r\n            );\r\n\r\n            this.progressManager.updateProgress(90, 'Setting initial state...');\r\n\r\n            // 初期状態設定\r\n            await this.playerInitializer.setInitialPlayerState(this.state.player);\r\n\r\n            // 初期角度表示を更新\r\n            this.uiManager.updateAngle(0);\r\n\r\n            this.state.isPlayerReady = true;\r\n            console.log('Player ready');\r\n\r\n            // プログレス完了\r\n            this.progressManager.updateProgress(100, 'Initialization complete!');\r\n\r\n            // ローディングオーバーレイを隠す\r\n            setTimeout(() => {\r\n                this.uiManager.hideLoadingOverlay();\r\n            }, 500);\r\n\r\n        } catch (error) {\r\n            console.error('Player initialization failed:', error);\r\n\r\n            const errorMessage = getErrorMessage(error);\r\n            if (errorMessage.includes('Failed to create Vimeo player')) {\r\n                this.showError('Player Error', 'Failed to create player. Check connection and reload.');\r\n            } else if (errorMessage.includes('Video not found')) {\r\n                this.showError('Video Not Found', 'The specified video was not found. Check the video ID.');\r\n            } else if (errorMessage.includes('Access denied')) {\r\n                this.showError('Access Denied', 'This video is private or restricted.');\r\n            } else if (errorMessage.includes('Failed to get video duration')) {\r\n                this.showError('Failed to Load', 'Could not retrieve video duration. Check network and reload.');\r\n            } else {\r\n                this.showError('Initialization Error', `Failed to load video player.<br><br>Error: ${errorMessage}<br><br>Click reload to retry.`);\r\n            }\r\n\r\n            this.videoConfigManager.setInitialSizeFallback(() => {\r\n                this.progressManager.adjustLoadingOverlaySize();\r\n            });\r\n            console.log('Error state maintained, loading overlay not hidden');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * イベントリスナーの追加\r\n     */\r\n    attachEventListeners(): void {\r\n        // DragHandlerを作成\r\n        this.dragHandler = new DragHandler(\r\n            this.container,\r\n            this.dragOverlay,\r\n            this.state,\r\n            this.config,\r\n            () => this.videoConfigManager.calculatePixelsPerRotation(),\r\n            (seconds) => this.uiManager.updateAngle(seconds)\r\n        );\r\n\r\n        this.dragHandler.attachEventListeners();\r\n        window.addEventListener('resize', this.onWindowResize.bind(this));\r\n    }\r\n\r\n    /**\r\n     * ウィンドウリサイズイベントハンドラー\r\n     */\r\n    async onWindowResize(): Promise<void> {\r\n        const newQuality = this.videoConfigManager.selectVideoQuality();\r\n        const currentSrc = this.iframe.src;\r\n\r\n        if (!currentSrc.includes(`quality=${newQuality}`)) {\r\n            console.log('Reinitializing player due to quality change:', newQuality);\r\n            this.state.isPlayerReady = false;\r\n            await this.initializePlayer();\r\n        }\r\n\r\n        const newPixelsPerRotation = this.videoConfigManager.calculatePixelsPerRotation();\r\n        console.log('Window resized, new PIXELS_PER_ROTATION:', newPixelsPerRotation);\r\n    }\r\n\r\n    /**\r\n     * エラー表示（ProgressManagerを使用）\r\n     */\r\n    private showError(title: string, message: string): void {\r\n        this.progressManager.showError(title, message);\r\n    }\r\n\r\n    /**\r\n     * エラー表示（非推奨：後方互換性のため残す）\r\n     */\r\n    private showError_old(title: string, message: string): void {\r\n        this.uiManager.showError(title, message);\r\n    }\r\n\r\n    /**\r\n     * クリーンアップ\r\n     */\r\n    destroy(): void {\r\n        if (this.dragHandler) {\r\n            this.dragHandler.removeEventListeners();\r\n        }\r\n        window.removeEventListener('resize', this.onWindowResize.bind(this));\r\n        console.log('TurntableViewer destroyed');\r\n    }\r\n}\r\n\r\n// グローバルにも公開（Web Component経由で使用）\r\nif (typeof window !== 'undefined') {\r\n    (window as any).TurntableViewer = TurntableViewer;\r\n}","/**\r\n * Web Turntable Viewer - Web Component (Shadow DOM)\r\n * カスタムエレメントとしてShadow DOMで完全に隔離されたウィジェット\r\n */\r\n\r\nimport styles from './turntable-viewer.css?inline';\r\nimport { TurntableViewer } from './turntable-viewer';\r\n\r\nexport class TurntableViewerElement extends HTMLElement {\r\n    private viewer: TurntableViewer | null = null;\r\n    private shadowContainer: HTMLElement | null = null;\r\n\r\n    static get observedAttributes() {\r\n        return ['vimeo-video-id', 'clockwise-rotation', 'width', 'height', 'show-angle'];\r\n    }\r\n\r\n    constructor() {\r\n        super();\r\n\r\n        // Shadow DOMをアタッチ（完全隔離）\r\n        this.attachShadow({ mode: 'open' });\r\n    }\r\n\r\n    connectedCallback() {\r\n        this.render();\r\n        this.initializeViewer();\r\n    }\r\n\r\n    disconnectedCallback() {\r\n        // クリーンアップ処理\r\n        if (this.viewer) {\r\n            // TurntableViewerにクリーンアップメソッドがあれば呼び出す\r\n        }\r\n    }\r\n\r\n    private render() {\r\n        const vimeoVideoId = this.getAttribute('vimeo-video-id');\r\n        const clockwiseRotation = this.getAttribute('clockwise-rotation');\r\n        const width = this.getAttribute('width') || '480';\r\n        const height = this.getAttribute('height') || '';\r\n        const showAngle = this.hasAttribute('show-angle');\r\n\r\n        if (!vimeoVideoId) {\r\n            console.error('vimeo-video-id attribute is required');\r\n            return;\r\n        }\r\n\r\n        // Shadow DOM内にHTMLとCSSを注入\r\n        if (this.shadowRoot) {\r\n            // clockwise-rotation属性を正しく伝播（指定時は必ずbool値が必要）\r\n            let clockwiseAttr = '';\r\n            if (clockwiseRotation !== null) {\r\n                clockwiseAttr = `clockwise-rotation=\"${clockwiseRotation}\"`;\r\n            }\r\n            // 属性がない場合は何も追加しない（デフォルトで時計回り）\r\n\r\n            this.shadowRoot.innerHTML = `\r\n                <style>${styles}</style>\r\n                <div class=\"turntable-wrapper\">\r\n                    <div id=\"turntable-container\" vimeo-video-id=\"${vimeoVideoId}\" ${clockwiseAttr} ${showAngle ? 'show-angle' : ''}>\r\n                        <iframe ${width ? `width=\"${width}\"` : ''} ${height ? `height=\"${height}\"` : ''} frameborder=\"0\" allowfullscreen></iframe>\r\n                        <div class=\"drag-overlay\">\r\n                            <button class=\"reload-button\" title=\"Reload video\">\r\n                                <svg class=\"reload-icon\" viewBox=\"0 0 24 24\">\r\n                                    <path d=\"M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2\"/>\r\n                                </svg>\r\n                            </button>\r\n                            <div id=\"angle-display\">\r\n                                <span id=\"angle\"><span id=\"rotation-angle\">0</span><span class=\"degree-symbol\">°</span></span>\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"loading-overlay\">\r\n                            <div class=\"loading-content\">\r\n                                <div class=\"loading-text\">Loading turntable...</div>\r\n                                <div class=\"progress-container\">\r\n                                    <div class=\"progress-bar\"><div class=\"progress-fill\"></div></div>\r\n                                    <div class=\"progress-text\">0%</div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    <a class=\"vimeo-link\" href=\"#\" target=\"_blank\">View on Vimeo</a>\r\n                </div>\r\n            `;\r\n\r\n            this.shadowContainer = this.shadowRoot.getElementById('turntable-container');\r\n        }\r\n    }\r\n\r\n    private initializeViewer() {\r\n        if (!this.shadowContainer || !this.shadowRoot) {\r\n            return;\r\n        }\r\n\r\n        try {\r\n            // TurntableViewerを初期化（Shadow DOM内で動作）\r\n            this.viewer = new TurntableViewer('turntable-container', this.shadowRoot);\r\n        } catch (error) {\r\n            console.error('Failed to initialize TurntableViewer:', error);\r\n        }\r\n    }\r\n}\r\n\r\n// カスタムエレメントを登録\r\nif (!customElements.get('turntable-viewer')) {\r\n    customElements.define('turntable-viewer', TurntableViewerElement);\r\n}\r\n","/**\r\n * Web Turntable Viewer Widget\r\n * Main entry point with Web Component support\r\n */\r\n\r\n// Web Componentのインポートと登録\r\nimport './turntable-viewer-element';\r\n\r\n// 既存のクラスもエクスポート（後方互換性のため）\r\nexport { TurntableViewer } from './turntable-viewer';\r\nexport { TurntableViewerElement } from './turntable-viewer-element';\r\n\r\n// グローバルにも公開\r\nimport { TurntableViewer } from './turntable-viewer';\r\nimport { TurntableViewerElement } from './turntable-viewer-element';\r\n\r\nif (typeof window !== 'undefined') {\r\n    (window as any).TurntableViewer = TurntableViewer;\r\n    (window as any).TurntableViewerElement = TurntableViewerElement;\r\n}\r\n"],"names":["ProgressManager","container","iframe","loadingOverlay","loadingText","progressFill","progressText","config","percentage","text","angleDisplay","iframeWidth","iframeHeight","defaultHeight","now","totalLoadingTime","timeSinceLastProgress","title","message","getErrorMessage","error","delay","ms","resolve","withTimeout","promise","timeoutMs","errorMessage","_","reject","VideoConfigManager","htmlWidth","containerWidth","computedWidth","finalWidth","pixelsPerRotation","videoWidth","videoHeight","htmlHeight","finalHeight","area","effectiveArea","devicePixelRatio","effectiveSize","limitedDPR","selectedQuality","quality","screenWidth","_a","availableWidth","params","url","oembedUrl","controller","timeoutId","response","data","aspectRatio","onProgress","onAdjustOverlay","currentWidth","currentHeight","videoInfo","calculatedHeight","calculatedWidth","defaultWidth","videoUrl","PlayerInitializer","player","isReloading","timeout","duration","currentAspectRatio","settings","setting","preloadPoints","i","point","seekTime","actions","action","DragHandler","dragOverlay","state","calculatePixelsPerRotation","onAngleUpdate","deltaX","rotationProgress","timeDelta","currentX","newTime","err","startX","UIManager","angleEl","progressManager","onReload","isLoading","seconds","angle","roundedAngle","wasHidden","vimeoLink","TurntableViewer","containerId","root","videoId","clockwiseAttr","isClockwise","parent","oldId","oldClassName","oldWidth","oldHeight","e","newIframe","progress","newQuality","newPixelsPerRotation","TurntableViewerElement","vimeoVideoId","clockwiseRotation","width","height","showAngle","styles"],"mappings":"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"}