{"version":3,"file":"turntable-viewer.esm.js","sources":["../src/progress-manager.ts","../src/utils.ts","../src/video-config-manager.ts","../src/player-initializer.ts","../src/drag-handler.ts","../src/ui-manager.ts","../src/turntable-viewer.ts"],"sourcesContent":["/**\n * プログレスバー管理クラス\n * ローディングオーバーレイとプログレスバーの表示・更新・タイムアウト検知を管理\n */\nexport class ProgressManager {\n    private loadingOverlay: HTMLElement;\n    private loadingText: HTMLElement;\n    private progressFill: HTMLElement;\n    private progressText: HTMLElement;\n    private container: HTMLElement;\n    private iframe: HTMLIFrameElement;\n\n    // タイムアウト検知用\n    private loadingStartTime: number | null = null;\n    private lastProgressTime: number = 0;\n    private lastProgressPercentage: number = 0;\n\n    constructor(\n        container: HTMLElement,\n        iframe: HTMLIFrameElement,\n        loadingOverlay: HTMLElement,\n        loadingText: HTMLElement,\n        progressFill: HTMLElement,\n        progressText: HTMLElement\n    ) {\n        this.container = container;\n        this.iframe = iframe;\n        this.loadingOverlay = loadingOverlay;\n        this.loadingText = loadingText;\n        this.progressFill = progressFill;\n        this.progressText = progressText;\n    }\n\n    /**\n     * プログレスバーを更新\n     */\n    updateProgress(percentage: number, text: string | null = null): void {\n        console.log(`Progress update: ${percentage}% - ${text || 'No text'}`);\n\n        if (this.progressFill) {\n            this.progressFill.style.width = `${percentage}%`;\n            console.log(`Progress fill updated to ${percentage}%`);\n        } else {\n            console.warn('Progress fill element not found');\n        }\n\n        if (this.progressText) {\n            this.progressText.textContent = `${Math.round(percentage)}%`;\n        } else {\n            console.warn('Progress text element not found');\n        }\n\n        if (text && this.loadingText) {\n            this.loadingText.textContent = text;\n        }\n\n        // ローディングタイムアウト監視\n        this.checkLoadingTimeout(percentage);\n    }\n\n    /**\n     * ローディングオーバーレイを表示\n     */\n    showLoadingOverlay(): void {\n        if (this.loadingOverlay) {\n            // ローディング中はAngle表示を即座に非表示\n            const angleDisplay = this.container.querySelector('#angle-display') as HTMLElement;\n            if (angleDisplay) {\n                angleDisplay.style.display = 'none';\n            }\n\n            this.loadingOverlay.classList.remove('hidden');\n            this.updateProgress(0, 'Initializing video player...');\n\n            // ローディングオーバーレイのサイズを即座に調整\n            this.adjustLoadingOverlaySize();\n            // 念のため少し遅延しても再調整\n            setTimeout(() => this.adjustLoadingOverlaySize(), 10);\n        }\n    }\n\n    /**\n     * ローディングオーバーレイを隠す\n     */\n    hideLoadingOverlay(): void {\n        if (this.loadingOverlay) {\n            setTimeout(() => {\n                this.loadingOverlay.classList.add('hidden');\n\n                // Angle表示を再表示（存在する場合のみ）\n                const angleDisplay = this.container.querySelector('#angle-display') as HTMLElement;\n                if (angleDisplay) {\n                    angleDisplay.style.display = 'block';\n                    console.log('Angle display made visible after loading');\n                } else {\n                    console.log('Angle display element not found (optional element)');\n                }\n            }, 500); // 少し遅延してスムーズに非表示\n        }\n    }\n\n    /**\n     * ローディングオーバーレイのサイズをiframe要素に合わせて調整\n     */\n    adjustLoadingOverlaySize(): void {\n        if (!this.loadingOverlay || !this.iframe) return;\n\n        // iframeの実際のサイズ（属性値）を取得\n        const iframeWidth = parseInt(this.iframe.getAttribute('width') || '0');\n        const iframeHeight = parseInt(this.iframe.getAttribute('height') || '0');\n\n        // どちらも設定されている場合はそのまま使用\n        if (iframeWidth && iframeHeight) {\n            this.loadingOverlay.style.width = `${iframeWidth}px`;\n            this.loadingOverlay.style.height = `${iframeHeight}px`;\n            console.log(`Adjusted loading overlay size: ${iframeWidth}x${iframeHeight}`);\n        } else {\n            // サイズが未確定の場合はデフォルト値を使用\n            const defaultWidth = 480;\n            const defaultHeight = Math.round(defaultWidth * (9 / 16));\n            this.loadingOverlay.style.width = `${defaultWidth}px`;\n            this.loadingOverlay.style.height = `${defaultHeight}px`;\n            console.log(`Adjusted loading overlay size to default: ${defaultWidth}x${defaultHeight}`);\n        }\n    }\n\n    /**\n     * ローディングタイムアウトをチェック\n     */\n    private checkLoadingTimeout(percentage: number): void {\n        // 初回またはリセット時にタイマー開始\n        if (!this.loadingStartTime) {\n            this.loadingStartTime = Date.now();\n            this.lastProgressTime = Date.now();\n            this.lastProgressPercentage = percentage;\n            return;\n        }\n\n        const now = Date.now();\n        const totalLoadingTime = now - this.loadingStartTime;\n        const timeSinceLastProgress = now - this.lastProgressTime;\n\n        // プログレスが進んだ場合は時間を更新\n        if (percentage > this.lastProgressPercentage) {\n            this.lastProgressTime = now;\n            this.lastProgressPercentage = percentage;\n            return;\n        }\n\n        // 30秒間プログレスが進んでいない場合、または総ローディング時間が60秒を超えた場合\n        const STALLED_TIMEOUT = 30000; // 30秒\n        const TOTAL_TIMEOUT = 60000;   // 60秒\n\n        if (timeSinceLastProgress > STALLED_TIMEOUT || totalLoadingTime > TOTAL_TIMEOUT) {\n            console.warn(`Loading timeout detected. Stalled: ${timeSinceLastProgress}ms, Total: ${totalLoadingTime}ms`);\n\n            // ローディングが停止していることを示す\n            if (this.loadingText) {\n                this.loadingText.textContent = 'ローディングが停止しました - リロードボタンを押してください';\n                this.loadingText.style.color = '#ff6b6b';\n            }\n\n            // タイムアウト検出をリセット（重複表示を防ぐ）\n            this.loadingStartTime = null;\n        }\n    }\n\n    /**\n     * タイムアウトタイマーをリセット\n     */\n    resetTimeout(): void {\n        this.loadingStartTime = null;\n        this.lastProgressTime = 0;\n        this.lastProgressPercentage = 0;\n    }\n\n    /**\n     * エラー表示（ローディングオーバーレイをエラー表示に変更）\n     */\n    showError(title: string, message: string): void {\n        if (!this.loadingOverlay) return;\n\n        // ローディングオーバーレイをエラー表示に変更\n        this.loadingOverlay.innerHTML = `\n                <div class=\"loading-content\">\n                    <div class=\"loading-text\" style=\"color: #ff6b6b;\">${title}</div>\n                    <div style=\"color: #ffa8a8; font-size: 11px; margin-top: 8px; line-height: 1.4;\">\n                        ${message}\n                    </div>\n                </div>\n            `;\n        this.loadingOverlay.style.display = 'flex';\n        this.loadingOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';\n\n        console.error(`${title}: ${message}`);\n    }\n}\n","/**\n * 共通ユーティリティ関数\n */\n\n/**\n * エラーメッセージを取得\n */\nexport function getErrorMessage(error: unknown): string {\n    if (error instanceof Error) return error.message;\n    return String(error);\n}\n\n/**\n * 遅延関数\n */\nexport function delay(ms: number): Promise<void> {\n    return new Promise(resolve => setTimeout(resolve, ms));\n}\n\n/**\n * デバウンス関数\n */\nexport function debounce<T extends (...args: any[]) => any>(\n    func: T,\n    wait: number\n): (...args: Parameters<T>) => void {\n    let timeout: ReturnType<typeof setTimeout> | undefined;\n    return function executedFunction(...args: Parameters<T>) {\n        const later = () => {\n            clearTimeout(timeout);\n            func(...args);\n        };\n        clearTimeout(timeout);\n        timeout = setTimeout(later, wait);\n    };\n}\n\n/**\n * タイムアウト付きPromise実行\n */\nexport function withTimeout<T = any>(\n    promise: Promise<T>,\n    timeoutMs: number,\n    errorMessage: string\n): Promise<T> {\n    return Promise.race([\n        promise,\n        new Promise<T>((_, reject) =>\n            setTimeout(() => reject(new Error(errorMessage || 'Operation timed out')), timeoutMs)\n        )\n    ]);\n}\n","import type { TurntableConfig, VideoInfo } from './types';\nimport { getErrorMessage, withTimeout, delay } from './utils';\n\n/**\n * 動画設定・品質・URL構築を管理するクラス\n */\nexport class VideoConfigManager {\n    private container: HTMLElement;\n    private iframe: HTMLIFrameElement;\n    private config: TurntableConfig;\n\n    constructor(container: HTMLElement, iframe: HTMLIFrameElement, config: TurntableConfig) {\n        this.container = container;\n        this.iframe = iframe;\n        this.config = config;\n    }\n\n    /**\n     * 表示サイズに基づいてPIXELS_PER_ROTATIONを動的に計算\n     */\n    calculatePixelsPerRotation(): number {\n        const htmlWidth = parseInt(this.iframe.getAttribute('width') || '0');\n        const containerWidth = this.container.clientWidth || 0;\n        const iframeWidth = this.iframe.clientWidth || 0;\n        const computedWidth = Math.max(containerWidth, iframeWidth) || 0;\n\n        const finalWidth = htmlWidth || computedWidth || 320;\n\n        console.log(`Container width for calculation: ${finalWidth}px (html: ${htmlWidth}, container: ${containerWidth}, iframe: ${iframeWidth})`);\n\n        const basePixels = 1200;\n        const baseScreenSize = 640;\n\n        let pixelsPerRotation = (finalWidth / baseScreenSize) * basePixels;\n\n        if (finalWidth <= 480) {\n            pixelsPerRotation *= 1.2;\n        }\n\n        pixelsPerRotation = Math.max(250, Math.min(3000, pixelsPerRotation));\n\n        console.log(`Calculated PIXELS_PER_ROTATION: ${Math.round(pixelsPerRotation)} for width: ${finalWidth}px`);\n        return Math.round(pixelsPerRotation);\n    }\n\n    /**\n     * 表示サイズに応じた動画品質選択\n     */\n    selectVideoQuality(): string {\n        const videoWidth = parseInt(this.container.getAttribute('video-width') || '0');\n        const videoHeight = parseInt(this.container.getAttribute('video-height') || '0');\n        const htmlWidth = parseInt(this.iframe.getAttribute('width') || '0');\n        const htmlHeight = parseInt(this.iframe.getAttribute('height') || '0');\n        const computedWidth = this.iframe.clientWidth || this.container.clientWidth || 0;\n        const computedHeight = this.iframe.clientHeight || this.container.clientHeight || 0;\n\n        const finalWidth = videoWidth || htmlWidth || computedWidth || 480;\n        const finalHeight = videoHeight || htmlHeight || finalWidth;\n\n        const area = finalWidth * finalHeight;\n        const effectiveArea = Math.sqrt(area);\n\n        const devicePixelRatio = window.devicePixelRatio || 1;\n\n        let effectiveSize;\n        if ((htmlWidth && htmlHeight) || (videoWidth && videoHeight)) {\n            const limitedDPR = Math.min(devicePixelRatio, 1.5);\n            effectiveSize = effectiveArea * limitedDPR;\n        } else {\n            effectiveSize = effectiveArea * devicePixelRatio;\n        }\n\n        let selectedQuality = '240p';\n        if (effectiveSize <= 240) {\n            selectedQuality = '240p';\n        } else if (effectiveSize <= 360) {\n            selectedQuality = '360p';\n        } else if (effectiveSize <= 480) {\n            selectedQuality = '540p';\n        } else if (effectiveSize <= 960) {\n            selectedQuality = '720p';\n        } else if (effectiveSize <= 1280) {\n            selectedQuality = '1080p';\n        } else if (effectiveSize <= 1920) {\n            selectedQuality = '2k';\n        } else {\n            selectedQuality = '4k';\n        }\n\n        console.log(`Selected quality: ${selectedQuality} for effective size: ${effectiveSize}px (${finalWidth}x${finalHeight})`);\n        return selectedQuality;\n    }\n\n    /**\n     * 動画URLを構築\n     */\n    buildVideoUrl(): string {\n        const quality = this.selectVideoQuality();\n\n        const videoWidth = parseInt(this.container.getAttribute('video-width') || '0');\n        const videoHeight = parseInt(this.container.getAttribute('video-height') || '0');\n        const htmlWidth = parseInt(this.iframe.getAttribute('width') || '0');\n        const htmlHeight = parseInt(this.iframe.getAttribute('height') || '0');\n\n        let finalWidth = videoWidth || htmlWidth || 480;\n        let finalHeight = videoHeight || htmlHeight || finalWidth;\n\n        const screenWidth = window.innerWidth || document.documentElement.clientWidth;\n        if (screenWidth <= 768) {\n            const containerWidth = this.container.clientWidth || this.container.parentElement?.clientWidth || screenWidth;\n            const availableWidth = Math.floor(containerWidth * 0.9);\n            if (availableWidth > 200) {\n                finalWidth = availableWidth;\n                finalHeight = availableWidth;\n            }\n        }\n\n        this.iframe.setAttribute('width', finalWidth.toString());\n        this.iframe.setAttribute('height', finalHeight.toString());\n\n        if (screenWidth <= 768) {\n            this.iframe.style.width = finalWidth + 'px';\n            this.iframe.style.height = finalHeight + 'px';\n            this.iframe.style.maxWidth = 'none';\n            this.iframe.style.display = 'block';\n            console.log(`Applied direct CSS styles: ${finalWidth}x${finalHeight}`);\n        }\n\n        const params = new URLSearchParams({\n            background: '1',\n            byline: '0',\n            portrait: '0',\n            title: '0',\n            speed: '0',\n            transparent: '1',\n            gesture: 'media',\n            autopause: '0',\n            muted: '1',\n            loop: '1',\n            controls: '0',\n            quality: quality,\n            responsive: '0',\n            dnt: '1'\n        });\n\n        const url = `https://player.vimeo.com/video/${this.config.videoId}?${params.toString()}`;\n        console.log(`Video URL set: ${url} (Size: ${finalWidth}x${finalHeight}, Screen: ${screenWidth})`);\n        return url;\n    }\n\n    /**\n     * Vimeo oEmbed APIから動画情報を事前取得\n     */\n    async getVideoInfoFromAPI(): Promise<VideoInfo> {\n        try {\n            if (!/^\\d+$/.test(this.config.videoId)) {\n                throw new Error('Invalid video ID format for API call');\n            }\n\n            const oembedUrl = `https://vimeo.com/api/oembed.json?url=https://vimeo.com/${this.config.videoId}`;\n            console.log(`Fetching video info from: ${oembedUrl}`);\n\n            await delay(Math.random() * 500);\n\n            const controller = new AbortController();\n            const timeoutId = setTimeout(() => controller.abort(), 10000);\n\n            const response = await fetch(oembedUrl, {\n                signal: controller.signal,\n                referrerPolicy: 'no-referrer',\n                headers: {\n                    'Accept': 'application/json'\n                }\n            });\n\n            clearTimeout(timeoutId);\n\n            if (!response.ok) {\n                if (response.status === 404) {\n                    throw new Error(`Video not found (ID: ${this.config.videoId}). Please check the video ID.`);\n                } else if (response.status === 403) {\n                    throw new Error(`Access denied to video (ID: ${this.config.videoId}). Video may be private.`);\n                } else if (response.status >= 500) {\n                    throw new Error(`Vimeo server error (status: ${response.status}). Please try again later.`);\n                } else {\n                    throw new Error(`HTTP error! status: ${response.status}`);\n                }\n            }\n\n            const data = await response.json();\n\n            if (!data || typeof data !== 'object') {\n                throw new Error('Invalid API response format');\n            }\n\n            if (!data.width || !data.height || data.width <= 0 || data.height <= 0) {\n                throw new Error('Invalid video dimensions in API response');\n            }\n\n            const aspectRatio = data.height / data.width;\n\n            console.log(`API Video dimensions: ${data.width}x${data.height}, aspect ratio: ${aspectRatio.toFixed(3)}`);\n\n            return {\n                width: data.width,\n                height: data.height,\n                aspectRatio: aspectRatio,\n                title: data.title || 'Untitled Video'\n            };\n        } catch (error) {\n            if ((error as any).name === 'AbortError') {\n                console.warn('API request timed out, using default aspect ratio');\n            } else {\n                console.warn('Could not fetch video info from API:', getErrorMessage(error));\n            }\n\n            return {\n                width: 1920,\n                height: 1080,\n                aspectRatio: 9 / 16,\n                title: 'Untitled Video'\n            };\n        }\n    }\n\n    /**\n     * 初期サイズを設定（API情報から）\n     */\n    async setInitialSizeFromAPI(\n        onProgress?: (progress: number, message: string) => void,\n        onAdjustOverlay?: () => void\n    ): Promise<void> {\n        try {\n            const currentWidth = parseInt(this.iframe.getAttribute('width') || '0');\n            const currentHeight = parseInt(this.iframe.getAttribute('height') || '0');\n\n            this.iframe.style.visibility = 'hidden';\n\n            if (currentWidth && currentHeight) {\n                console.log(`Both width and height specified: ${currentWidth}x${currentHeight}`);\n                this.container.classList.add('initialized');\n                this.iframe.style.visibility = 'visible';\n                this.iframe.classList.add('size-ready');\n                console.log('Container and iframe ready with fixed size');\n                onAdjustOverlay?.();\n                return;\n            }\n\n            if (currentWidth || currentHeight) {\n                onProgress?.(5, 'Getting video information...');\n\n                const videoInfo = await this.getVideoInfoFromAPI();\n\n                if (currentWidth && !currentHeight) {\n                    const calculatedHeight = Math.round(currentWidth * videoInfo.aspectRatio);\n                    this.iframe.setAttribute('height', calculatedHeight.toString());\n                    console.log(`Set height from width: ${currentWidth}x${calculatedHeight} (aspect ratio: ${videoInfo.aspectRatio.toFixed(3)})`);\n                } else if (currentHeight && !currentWidth) {\n                    const calculatedWidth = Math.round(currentHeight / videoInfo.aspectRatio);\n                    this.iframe.setAttribute('width', calculatedWidth.toString());\n                    console.log(`Set width from height: ${calculatedWidth}x${currentHeight} (aspect ratio: ${videoInfo.aspectRatio.toFixed(3)})`);\n                }\n\n                this.container.classList.add('initialized');\n                this.iframe.style.visibility = 'visible';\n                this.iframe.classList.add('size-ready');\n                console.log('Container and iframe size ready, made visible');\n\n                onAdjustOverlay?.();\n            } else {\n                const defaultWidth = 480;\n                onProgress?.(5, 'Getting video information...');\n\n                const videoInfo = await this.getVideoInfoFromAPI();\n                const calculatedHeight = Math.round(defaultWidth * videoInfo.aspectRatio);\n\n                this.iframe.setAttribute('width', defaultWidth.toString());\n                this.iframe.setAttribute('height', calculatedHeight.toString());\n                console.log(`Set default size: ${defaultWidth}x${calculatedHeight} (aspect ratio: ${videoInfo.aspectRatio.toFixed(3)})`);\n\n                this.container.classList.add('initialized');\n                this.iframe.style.visibility = 'visible';\n                this.iframe.classList.add('size-ready');\n                console.log('Container and iframe size ready with default size');\n\n                onAdjustOverlay?.();\n            }\n\n            console.log('setInitialSizeFromAPI completed');\n        } catch (error) {\n            console.warn('Could not set initial size from API:', error);\n            this.setInitialSizeFallback(onAdjustOverlay);\n        }\n    }\n\n    /**\n     * 初期サイズを設定（フォールバック版）\n     */\n    setInitialSizeFallback(onAdjustOverlay?: () => void): void {\n        try {\n            const currentWidth = parseInt(this.iframe.getAttribute('width') || '0');\n            const currentHeight = parseInt(this.iframe.getAttribute('height') || '0');\n\n            if (currentWidth && currentHeight) {\n                console.log(`Fallback: Both width and height specified: ${currentWidth}x${currentHeight}`);\n            } else if (currentWidth && !currentHeight) {\n                const defaultHeight = Math.round(currentWidth * (9 / 16));\n                this.iframe.setAttribute('height', defaultHeight.toString());\n                console.log(`Fallback: Set height from width: ${currentWidth}x${defaultHeight} (16:9 default aspect ratio)`);\n            } else if (currentHeight && !currentWidth) {\n                const defaultWidth = Math.round(currentHeight / (9 / 16));\n                this.iframe.setAttribute('width', defaultWidth.toString());\n                console.log(`Fallback: Set width from height: ${defaultWidth}x${currentHeight} (16:9 default aspect ratio)`);\n            } else {\n                const defaultWidth = 480;\n                const defaultHeight = Math.round(defaultWidth * (9 / 16));\n                this.iframe.setAttribute('width', defaultWidth.toString());\n                this.iframe.setAttribute('height', defaultHeight.toString());\n                console.log(`Fallback: Set default size: ${defaultWidth}x${defaultHeight} (16:9 default aspect ratio)`);\n            }\n\n            this.container.classList.add('initialized');\n            this.iframe.style.visibility = 'visible';\n            this.iframe.classList.add('size-ready');\n            console.log('Container and iframe size ready (fallback), made visible');\n\n            onAdjustOverlay?.();\n        } catch (error) {\n            console.warn('Could not set fallback initial size:', error);\n        }\n    }\n\n    /**\n     * 動画プレイヤーのセットアップ\n     */\n    setupVideoPlayer(): void {\n        const videoUrl = this.buildVideoUrl();\n        this.iframe.src = videoUrl;\n    }\n}\n","import type { TurntableState } from './types';\nimport { getErrorMessage, withTimeout, delay } from './utils';\n\n/**\n * プレイヤー初期化と事前ロードを管理するクラス\n */\nexport class PlayerInitializer {\n    private iframe: HTMLIFrameElement;\n    private container: HTMLElement;\n\n    constructor(container: HTMLElement, iframe: HTMLIFrameElement) {\n        this.container = container;\n        this.iframe = iframe;\n    }\n\n    /**\n     * Vimeoプレイヤーを作成\n     */\n    async createPlayer(onProgress?: (progress: number, message: string) => void): Promise<any> {\n        try {\n            onProgress?.(40, 'Connecting to player...');\n            // @ts-ignore - VimeoはグローバルにCDNから読み込まれている\n            const player = new Vimeo.Player(this.iframe);\n            return player;\n        } catch (error) {\n            throw new Error(`Failed to create Vimeo player: ${getErrorMessage(error)}`);\n        }\n    }\n\n    /**\n     * プレイヤーの基本情報取得\n     */\n    async getPlayerDuration(player: any, isReloading: boolean = false, onProgress?: (progress: number, message: string) => void): Promise<number> {\n        onProgress?.(60, 'Loading player settings...');\n\n        // リロード時はタイムアウトを長くする\n        const timeout = isReloading ? 15000 : 10000;\n        const duration = await withTimeout(\n            player.getDuration(),\n            timeout,\n            'Failed to get video duration'\n        );\n        console.log('Duration:', duration);\n\n        if (!duration || duration <= 0) {\n            throw new Error('Invalid video duration received');\n        }\n\n        return duration;\n    }\n\n    /**\n     * 動画のアスペクト比を調整（プレイヤー情報から詳細確認）\n     */\n    async adjustVideoAspectRatio(player: any, onAdjustOverlay?: () => void): Promise<void> {\n        try {\n            console.log('Getting video dimensions...');\n            const videoWidth = await withTimeout(\n                player.getVideoWidth(),\n                3000,\n                'Failed to get video width'\n            );\n            const videoHeight = await withTimeout(\n                player.getVideoHeight(),\n                3000,\n                'Failed to get video height'\n            );\n            const aspectRatio = videoHeight / videoWidth;\n\n            console.log(`Player Video dimensions: ${videoWidth}x${videoHeight}, aspect ratio: ${aspectRatio.toFixed(3)}`);\n\n            const currentWidth = parseInt(this.iframe.getAttribute('width') || '480');\n            const currentHeight = parseInt(this.iframe.getAttribute('height') || '480');\n            const currentAspectRatio = currentHeight / currentWidth;\n            const specifiedVideoHeight = parseInt(this.container.getAttribute('video-height') || '0');\n\n            if (!specifiedVideoHeight && Math.abs(currentAspectRatio - aspectRatio) > 0.01) {\n                const calculatedHeight = Math.round(currentWidth * aspectRatio);\n                this.iframe.setAttribute('height', calculatedHeight.toString());\n                console.log(`Fine-tuned iframe size: ${currentWidth}x${calculatedHeight} (aspect ratio: ${aspectRatio.toFixed(3)})`);\n\n                onAdjustOverlay?.();\n            } else {\n                console.log('Aspect ratio already correct, no adjustment needed');\n            }\n        } catch (error) {\n            console.warn('Could not get video dimensions, keeping current size:', getErrorMessage(error));\n            onAdjustOverlay?.();\n        }\n    }\n\n    /**\n     * プレイヤー設定を個別にエラーハンドリング付きで適用\n     */\n    async applyPlayerSettings(player: any, onProgress?: (progress: number, message: string) => void): Promise<void> {\n        onProgress?.(75, 'Applying player settings...');\n\n        const settings = [\n            {\n                name: 'loop',\n                action: () => player.setLoop(true),\n                fallback: () => console.warn('Could not set loop mode')\n            },\n            {\n                name: 'volume',\n                action: () => player.setVolume(0),\n                fallback: () => console.warn('Could not set volume')\n            }\n        ];\n\n        for (const setting of settings) {\n            try {\n                await withTimeout(setting.action(), 3000, `Failed to set ${setting.name}`);\n                console.log(`Successfully set ${setting.name}`);\n            } catch (error) {\n                console.warn(`Setting ${setting.name} failed:`, getErrorMessage(error));\n                setting.fallback();\n            }\n        }\n    }\n\n    /**\n     * 動画の事前ロード（失敗しても続行可能）\n     */\n    async preloadVideo(player: any, duration: number, onProgress?: (progress: number, message: string) => void): Promise<boolean> {\n        try {\n            onProgress?.(85, 'Buffering video...');\n            console.log('Starting video buffer preload...');\n\n            // 再生せずにseekだけでバッファリング（ブラウザの自動再生ブロックを回避）\n            const preloadPoints = [0, 0.5];\n            for (let i = 0; i < preloadPoints.length; i++) {\n                const point = preloadPoints[i];\n                const seekTime = duration * point;\n                await withTimeout(\n                    player.setCurrentTime(seekTime),\n                    5000,\n                    `Preload seek timeout at ${point * 100}%`\n                );\n                await delay(300);\n\n                onProgress?.(85 + (i + 1) * 2, `Buffering ${Math.round(point * 100)}%...`);\n            }\n\n            await withTimeout(player.setCurrentTime(0), 5000, 'Preload final seek timeout');\n\n            console.log('Video buffer preload completed');\n            return true;\n        } catch (error) {\n            // バッファリングはオプショナルなので、失敗しても問題ない\n            console.log('Video buffer preload skipped:', getErrorMessage(error));\n            return false;\n        }\n    }\n\n    /**\n     * 初期プレイヤー状態の設定\n     */\n    async setInitialPlayerState(player: any, onProgress?: (progress: number, message: string) => void): Promise<void> {\n        onProgress?.(90, 'Setting initial state...');\n\n        // playはブラウザの自動再生ポリシーでブロックされる可能性があるが、\n        // pauseとseekが成功すればウィジェットは機能する\n        const actions = [\n            { name: 'play', action: () => player.play(), optional: true },\n            { name: 'pause', action: () => player.pause(), optional: false },\n            { name: 'seek to start', action: () => player.setCurrentTime(0), optional: false }\n        ];\n\n        for (const action of actions) {\n            try {\n                await withTimeout(action.action(), 3000, `Failed to ${action.name}`);\n                console.log(`Successfully executed: ${action.name}`);\n            } catch (error) {\n                if (action.optional) {\n                    // オプショナルな操作（play等）の失敗は通常動作\n                    console.log(`${action.name} skipped (likely blocked by browser autoplay policy)`);\n                } else {\n                    // 必須の操作（pause/seek）の失敗は警告\n                    console.warn(`Action ${action.name} failed:`, getErrorMessage(error));\n                }\n            }\n        }\n    }\n}\n","import type { TurntableConfig, TurntableState } from './types';\n\n/**\n * ドラッグ操作とイベント処理を管理するクラス\n */\nexport class DragHandler {\n    private container: HTMLElement;\n    private dragOverlay: HTMLElement;\n    private state: TurntableState;\n    private config: TurntableConfig;\n    private calculatePixelsPerRotation: () => number;\n    private onAngleUpdate: (seconds: number) => void;\n\n    // バインド済みのイベントハンドラー\n    private boundMouseDown: (e: MouseEvent) => Promise<void>;\n    private boundMouseMove: (e: MouseEvent) => void;\n    private boundMouseUp: () => void;\n    private boundTouchStart: (e: TouchEvent) => Promise<void>;\n    private boundTouchMove: (e: TouchEvent) => void;\n    private boundTouchEnd: (e: TouchEvent) => void;\n\n    constructor(\n        container: HTMLElement,\n        dragOverlay: HTMLElement,\n        state: TurntableState,\n        config: TurntableConfig,\n        calculatePixelsPerRotation: () => number,\n        onAngleUpdate: (seconds: number) => void\n    ) {\n        this.container = container;\n        this.dragOverlay = dragOverlay;\n        this.state = state;\n        this.config = config;\n        this.calculatePixelsPerRotation = calculatePixelsPerRotation;\n        this.onAngleUpdate = onAngleUpdate;\n\n        // イベントハンドラーをバインド\n        this.boundMouseDown = this.onMouseDown.bind(this);\n        this.boundMouseMove = this.onMouseMove.bind(this);\n        this.boundMouseUp = this.onMouseUp.bind(this);\n        this.boundTouchStart = this.onTouchStart.bind(this);\n        this.boundTouchMove = this.onTouchMove.bind(this);\n        this.boundTouchEnd = this.onTouchEnd.bind(this);\n    }\n\n    /**\n     * イベントリスナーを追加\n     */\n    attachEventListeners(): void {\n        this.dragOverlay.addEventListener('mousedown', this.boundMouseDown);\n        this.dragOverlay.addEventListener('touchstart', this.boundTouchStart, { passive: false });\n    }\n\n    /**\n     * イベントリスナーを削除\n     */\n    removeEventListeners(): void {\n        this.dragOverlay.removeEventListener('mousedown', this.boundMouseDown);\n        this.dragOverlay.removeEventListener('touchstart', this.boundTouchStart);\n        document.removeEventListener('mousemove', this.boundMouseMove);\n        document.removeEventListener('mouseup', this.boundMouseUp);\n        document.removeEventListener('touchmove', this.boundTouchMove);\n        document.removeEventListener('touchend', this.boundTouchEnd);\n    }\n\n    /**\n     * 新しい再生時間を計算（ループ対応）\n     */\n    private calculateNewTime(deltaX: number): number {\n        const sensitivityFactor = 0.9;\n        const pixelsPerRotation = this.calculatePixelsPerRotation();\n        const adjustedDelta = deltaX * sensitivityFactor;\n        const rotationProgress = adjustedDelta / pixelsPerRotation;\n\n        const timeDelta = this.config.isClockwise\n            ? -rotationProgress * this.state.duration\n            : rotationProgress * this.state.duration;\n\n        let newTime = this.state.startTime + timeDelta;\n\n        return ((newTime % this.state.duration) + this.state.duration) % this.state.duration;\n    }\n\n    /**\n     * ドラッグ操作の共通処理\n     */\n    private handleDragMove(currentX: number): void {\n        if (!this.state.isDragging || !this.state.isPlayerReady) return;\n\n        if (this.state.startTime === undefined || this.state.startTime === null) return;\n        if (this.state.dragStartX === undefined || this.state.dragStartX === null) return;\n\n        const deltaX = currentX - this.state.dragStartX;\n\n        if (Math.abs(deltaX) > 2000) {\n            console.warn('Extreme deltaX detected, ignoring:', deltaX);\n            return;\n        }\n\n        const newTime = this.calculateNewTime(deltaX);\n\n        // UI更新を即座に実行\n        this.onAngleUpdate(newTime);\n\n        const now = performance.now();\n        const shouldThrottle = now - this.state.lastDragUpdate < 100;\n\n        if (!shouldThrottle) {\n            this.state.lastDragUpdate = now;\n\n            if (this.state.pendingApiCall) {\n                cancelAnimationFrame(this.state.pendingApiCall);\n            }\n\n            this.state.pendingApiCall = requestAnimationFrame(() => {\n                if (this.state.isDragging && this.state.isPlayerReady) {\n                    this.state.player?.setCurrentTime(newTime).catch((err: any) => {\n                        console.warn('Vimeo API call ignored due to performance:', err);\n                    });\n                }\n                this.state.pendingApiCall = null;\n            });\n        }\n    }\n\n    /**\n     * ドラッグ開始の共通処理\n     */\n    private async handleDragStart(startX: number): Promise<boolean> {\n        if (!this.state.isPlayerReady) return false;\n\n        this.state.isDragging = false;\n        this.state.dragStartX = startX;\n        this.dragOverlay.style.cursor = 'grabbing';\n\n        try {\n            this.state.startTime = await this.state.player.getCurrentTime();\n            this.state.isDragging = true;\n\n            this.dragOverlay.classList.add('dragging');\n            this.container.classList.add('dragging');\n\n            this.state.dragStartX = startX;\n\n            console.log('Drag started at time:', this.state.startTime, 'position:', startX);\n            return true;\n        } catch (error) {\n            console.error('Failed to get current time:', error);\n            this.state.isDragging = false;\n            this.dragOverlay.classList.remove('dragging');\n            this.container.classList.remove('dragging');\n            this.dragOverlay.style.cursor = 'grab';\n            return false;\n        }\n    }\n\n    /**\n     * ドラッグ終了の共通処理\n     */\n    private handleDragEnd(): void {\n        if (!this.state.isDragging) return;\n\n        this.state.isDragging = false;\n\n        this.dragOverlay.classList.remove('dragging');\n        this.container.classList.remove('dragging');\n\n        if (this.state.pendingApiCall) {\n            cancelAnimationFrame(this.state.pendingApiCall);\n            this.state.pendingApiCall = null;\n        }\n\n        this.dragOverlay.style.cursor = 'grab';\n        this.state.player?.pause();\n    }\n\n    /**\n     * マウスダウンイベントハンドラー\n     */\n    private async onMouseDown(e: MouseEvent): Promise<void> {\n        if (this.state.isDragging) return;\n\n        const success = await this.handleDragStart(e.clientX);\n        if (!success) return;\n\n        document.addEventListener('mousemove', this.boundMouseMove);\n        document.addEventListener('mouseup', this.boundMouseUp);\n        e.preventDefault();\n    }\n\n    /**\n     * マウスムーブイベントハンドラー\n     */\n    private onMouseMove(e: MouseEvent): void {\n        this.handleDragMove(e.clientX);\n    }\n\n    /**\n     * マウスアップイベントハンドラー\n     */\n    private onMouseUp(): void {\n        this.handleDragEnd();\n        document.removeEventListener('mousemove', this.boundMouseMove);\n        document.removeEventListener('mouseup', this.boundMouseUp);\n    }\n\n    /**\n     * タッチスタートイベントハンドラー\n     */\n    private async onTouchStart(e: TouchEvent): Promise<void> {\n        if (this.state.isDragging) return;\n\n        e.preventDefault();\n        e.stopPropagation();\n\n        const success = await this.handleDragStart(e.touches[0].clientX);\n        if (!success) return;\n\n        document.addEventListener('touchmove', this.boundTouchMove, { passive: false });\n        document.addEventListener('touchend', this.boundTouchEnd, { passive: false });\n    }\n\n    /**\n     * タッチムーブイベントハンドラー\n     */\n    private onTouchMove(e: TouchEvent): void {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this.handleDragMove(e.touches[0].clientX);\n    }\n\n    /**\n     * タッチエンドイベントハンドラー\n     */\n    private onTouchEnd(e: TouchEvent): void {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this.handleDragEnd();\n        document.removeEventListener('touchmove', this.boundTouchMove);\n        document.removeEventListener('touchend', this.boundTouchEnd);\n    }\n}\n","import type { TurntableConfig, TurntableState } from './types';\nimport { ProgressManager } from './progress-manager';\n\n/**\n * UI更新を管理するクラス（角度表示、リロードボタン、Vimeoリンク）\n */\nexport class UIManager {\n    private container: HTMLElement;\n    private iframe: HTMLIFrameElement;\n    private angleEl: HTMLElement | null;\n    private angleDisplay: HTMLElement | null;\n    private reloadButton: HTMLButtonElement;\n    private config: TurntableConfig;\n    private state: TurntableState;\n    private progressManager: ProgressManager;\n    private onReload: () => Promise<void>;\n\n    constructor(\n        container: HTMLElement,\n        iframe: HTMLIFrameElement,\n        angleEl: HTMLElement | null,\n        angleDisplay: HTMLElement | null,\n        config: TurntableConfig,\n        state: TurntableState,\n        progressManager: ProgressManager,\n        onReload: () => Promise<void>\n    ) {\n        this.container = container;\n        this.iframe = iframe;\n        this.angleEl = angleEl;\n        this.angleDisplay = angleDisplay;\n        this.config = config;\n        this.state = state;\n        this.progressManager = progressManager;\n        this.onReload = onReload;\n\n        // リロードボタンを作成\n        this.reloadButton = document.createElement('button');\n        this.createReloadButton();\n    }\n\n    /**\n     * リロードボタンを作成\n     */\n    private createReloadButton(): void {\n        this.reloadButton.className = 'reload-button';\n        this.reloadButton.title = 'ビデオを再読み込み';\n\n        this.reloadButton.innerHTML = `\n            <svg class=\"reload-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\n                <path d=\"M23 4v6h-6\"/>\n                <path d=\"M20.49 15a9 9 0 1 1-2.12-9.36L23 10\"/>\n            </svg>\n        `;\n\n        this.reloadButton.addEventListener('click', () => {\n            this.onReload();\n        });\n\n        this.container.appendChild(this.reloadButton);\n    }\n\n    /**\n     * リロードボタンを表示\n     */\n    showReloadButton(): void {\n        if (this.reloadButton) {\n            this.reloadButton.style.display = 'flex';\n        }\n    }\n\n    /**\n     * リロードボタンを非表示\n     */\n    hideReloadButton(): void {\n        if (this.reloadButton) {\n            this.reloadButton.style.display = 'none';\n        }\n    }\n\n    /**\n     * リロード処理のローディング状態を設定\n     */\n    setReloadLoading(isLoading: boolean): void {\n        if (isLoading) {\n            this.reloadButton.classList.add('loading');\n        } else {\n            this.reloadButton.classList.remove('loading');\n        }\n    }\n\n    /**\n     * 角度表示更新\n     */\n    updateAngle(seconds: number): void {\n        let angle;\n\n        if (this.config.isClockwise) {\n            angle = (seconds / this.state.duration) * 360;\n        } else {\n            angle = 360 - (seconds / this.state.duration) * 360;\n        }\n\n        angle = angle % 360;\n        if (angle < 0) angle += 360;\n\n        if (!this.angleEl) return;\n\n        const roundedAngle = Math.round(angle);\n        if (this.state.isDragging) {\n            this.angleEl.textContent = roundedAngle.toString();\n            this.state.lastDisplayedAngle = roundedAngle;\n        } else {\n            if (this.state.lastDisplayedAngle !== roundedAngle) {\n                this.angleEl.textContent = roundedAngle.toString();\n                this.state.lastDisplayedAngle = roundedAngle;\n            }\n        }\n    }\n\n    /**\n     * 角度表示の位置を調整\n     */\n    adjustAngleDisplayPosition(): void {\n        if (!this.angleDisplay || !this.iframe) {\n            console.log('angleDisplay or iframe not found, skipping position adjustment');\n            return;\n        }\n\n        const wasHidden = this.angleDisplay.style.display === 'none';\n        if (wasHidden) {\n            this.angleDisplay.style.visibility = 'hidden';\n            this.angleDisplay.style.display = 'block';\n        }\n\n        console.log('Angle display positioned at bottom center via CSS');\n\n        if (wasHidden) {\n            this.angleDisplay.style.display = 'none';\n            this.angleDisplay.style.visibility = 'visible';\n        }\n    }\n\n    /**\n     * 角度表示を表示\n     */\n    showAngleDisplay(): void {\n        if (this.angleDisplay) {\n            this.adjustAngleDisplayPosition();\n            this.angleDisplay.style.display = 'block';\n            console.log('Angle display enabled after successful initialization and position adjustment');\n        }\n    }\n\n    /**\n     * 角度表示を非表示\n     */\n    hideAngleDisplay(): void {\n        if (this.angleDisplay) {\n            this.angleDisplay.style.display = 'none';\n        }\n    }\n\n    /**\n     * Vimeoリンクを表示\n     */\n    showVimeoLink(): void {\n        const vimeoLink = (this.container.parentNode?.querySelector('.vimeo-link') ||\n            this.container.querySelector('.vimeo-link')) as HTMLAnchorElement;\n        if (vimeoLink && this.config.videoId) {\n            if (!/^\\d+$/.test(this.config.videoId)) {\n                console.warn('Invalid video ID format detected, skipping Vimeo link generation');\n                return;\n            }\n\n            vimeoLink.href = `https://vimeo.com/${this.config.videoId}`;\n\n            if (this.iframe) {\n                const videoWidth = this.iframe.offsetWidth;\n                if (videoWidth > 0) {\n                    vimeoLink.style.width = `${videoWidth}px`;\n                    console.log(`Vimeo link width adjusted to ${videoWidth}px`);\n                }\n            }\n\n            vimeoLink.classList.add('visible');\n            console.log('Vimeo link displayed');\n        } else if (!vimeoLink) {\n            console.log('Vimeo link element not found (optional element)');\n        }\n    }\n\n    /**\n     * ローディングオーバーレイを隠す（UI調整含む）\n     */\n    hideLoadingOverlay(): void {\n        this.progressManager.hideLoadingOverlay();\n\n        if (this.angleDisplay) {\n            this.adjustAngleDisplayPosition();\n        }\n\n        this.showVimeoLink();\n    }\n\n    /**\n     * エラー表示\n     */\n    showError(title: string, message: string): void {\n        this.progressManager.showError(title, message);\n    }\n}\n","// CSSをインポート\nimport './turntable-viewer.css';\nimport type { TurntableConfig, TurntableState } from './types';\nimport { ProgressManager } from './progress-manager';\nimport { VideoConfigManager } from './video-config-manager';\nimport { PlayerInitializer } from './player-initializer';\nimport { DragHandler } from './drag-handler';\nimport { UIManager } from './ui-manager';\nimport { getErrorMessage, delay } from './utils';\n\n/**\n * Web Turntable Viewer\n * ドラッグ操作で360度回転表示を制御するクラス\n */\nclass TurntableViewer {\n    private container: HTMLElement;\n    private iframe: HTMLIFrameElement;\n    private dragOverlay: HTMLElement;\n    private config: TurntableConfig;\n    private state: TurntableState;\n    private isReloading: boolean = false;\n\n    // マネージャークラス\n    private progressManager: ProgressManager;\n    private videoConfigManager: VideoConfigManager;\n    private playerInitializer: PlayerInitializer;\n    private dragHandler: DragHandler | null = null;\n    private uiManager: UIManager;\n\n    constructor(containerId: string) {\n        // DOM要素の取得\n        const container = document.getElementById(containerId);\n        if (!container) {\n            throw new Error(`Container element with id \"${containerId}\" not found`);\n        }\n        this.container = container;\n\n        const iframe = this.container.querySelector<HTMLIFrameElement>('iframe');\n        if (!iframe) {\n            throw new Error('iframe element not found in container');\n        }\n        this.iframe = iframe;\n\n        const angleEl = this.container.querySelector<HTMLElement>('#rotation-angle');\n        const angleDisplay = this.container.querySelector<HTMLElement>('#angle-display');\n\n        const dragOverlay = this.container.querySelector<HTMLElement>('.drag-overlay');\n        if (!dragOverlay) {\n            throw new Error('drag-overlay element not found in container');\n        }\n        this.dragOverlay = dragOverlay;\n\n        // プログレスバー関連要素\n        const loadingOverlay = this.container.querySelector<HTMLElement>('.loading-overlay');\n        const loadingText = this.container.querySelector<HTMLElement>('.loading-text');\n        const progressFill = this.container.querySelector<HTMLElement>('.progress-fill');\n        const progressText = this.container.querySelector<HTMLElement>('.progress-text');\n\n        if (!loadingOverlay || !loadingText || !progressFill || !progressText) {\n            throw new Error('Required loading elements not found in container');\n        }\n\n        // ProgressManagerを初期化\n        this.progressManager = new ProgressManager(\n            this.container,\n            this.iframe,\n            loadingOverlay,\n            loadingText,\n            progressFill,\n            progressText\n        );\n\n        // DOM要素の存在確認\n        console.log('DOM elements check:');\n        console.log('- container:', !!this.container);\n        console.log('- iframe:', !!this.iframe);\n        console.log('- loadingOverlay:', !!loadingOverlay);\n        console.log('- progressFill:', !!progressFill);\n        console.log('- progressText:', !!progressText);\n        console.log('- loadingText:', !!loadingText);\n        console.log('- angleEl (optional):', !!angleEl);\n        console.log('- angleDisplay (optional):', !!angleDisplay);\n\n        // 必須要素のチェック\n        if (!this.container || !this.iframe || !loadingOverlay) {\n            throw new Error('Required elements not found: container, iframe, or loading-overlay');\n        }\n\n        console.log('DOM elements validation passed');\n\n        // 設定を取得\n        try {\n            this.config = this.getConfig();\n            console.log('Configuration loaded:', this.config);\n        } catch (error) {\n            const message = getErrorMessage(error);\n            console.error('Configuration error:', message);\n            this.showError('Configuration Error', message);\n            throw error;\n        }\n\n        // 状態管理\n        this.state = {\n            player: null,\n            duration: 0,\n            isPlayerReady: false,\n            isDragging: false,\n            dragStartX: 0,\n            startTime: 0,\n            lastDragUpdate: 0,\n            lastDisplayedAngle: null,\n            pendingApiCall: null\n        };\n\n        // マネージャークラスを初期化\n        this.videoConfigManager = new VideoConfigManager(this.container, this.iframe, this.config);\n        this.playerInitializer = new PlayerInitializer(this.container, this.iframe);\n        this.uiManager = new UIManager(\n            this.container,\n            this.iframe,\n            angleEl,\n            angleDisplay,\n            this.config,\n            this.state,\n            this.progressManager,\n            this.handleReload.bind(this)\n        );\n\n        // 初期化\n        this.initialize();\n    }\n\n    /**\n     * 設定を取得\n     */\n    getConfig(): TurntableConfig {\n        const videoId = this.container.getAttribute('vimeo-video-id');\n        const clockwiseAttr = this.container.getAttribute('clockwise-rotation');\n        let isClockwise = true;\n\n        if (clockwiseAttr !== null) {\n            if (clockwiseAttr === '' || clockwiseAttr === 'true' || clockwiseAttr === '1') {\n                isClockwise = true;\n            } else if (clockwiseAttr === 'false' || clockwiseAttr === '0') {\n                isClockwise = false;\n            } else {\n                console.warn(`Invalid clockwise-rotation attribute value: \"${clockwiseAttr}\". Using default \"true\".`);\n                isClockwise = true;\n            }\n        }\n\n        if (!videoId) {\n            throw new Error('vimeo-video-id attribute is required on the container element');\n        }\n\n        if (!/^\\d+$/.test(videoId)) {\n            throw new Error(`Invalid vimeo-video-id format: \"${videoId}\". Only numeric IDs are allowed.`);\n        }\n\n        return {\n            RESIZE_DEBOUNCE_MS: 500,\n            PLAYER_LOAD_DELAY_MS: 1000,\n            DRAG_THROTTLE_MS: 16,\n            isClockwise: isClockwise,\n            videoId: videoId\n        };\n    }\n\n    /**\n     * 初期化\n     */\n    async initialize(): Promise<void> {\n        this.uiManager.hideAngleDisplay();\n        this.progressManager.showLoadingOverlay();\n\n        try {\n            await this.initializePlayer();\n            this.attachEventListeners();\n            console.log('TurntableViewer initialized successfully');\n\n            this.uiManager.showAngleDisplay();\n        } catch (error) {\n            console.error('TurntableViewer initialization failed:', error);\n            this.progressManager.updateProgress(100, '初期化エラーが発生しました');\n            this.uiManager.hideLoadingOverlay();\n        }\n    }\n\n    /**\n     * リロード処理\n     */\n    async handleReload(): Promise<void> {\n        if (this.isReloading) return;\n\n        this.isReloading = true;\n        this.uiManager.setReloadLoading(true);\n\n        try {\n            console.log('Reloading turntable viewer...');\n\n            // DragHandlerのイベントリスナーを削除\n            if (this.dragHandler) {\n                this.dragHandler.removeEventListeners();\n                this.dragHandler = null;\n            }\n\n            // iframe情報をプレイヤー破棄前に保存（destroy が iframe を削除する可能性があるため）\n            if (!this.iframe || !this.iframe.parentElement) {\n                console.error('iframe or parent element not found, cannot reload');\n                throw new Error('Cannot reload: iframe element not properly initialized');\n            }\n\n            const parent = this.iframe.parentElement;\n            const oldId = this.iframe.id;\n            const oldClassName = this.iframe.className;\n            const oldWidth = this.iframe.getAttribute('width') || '';\n            const oldHeight = this.iframe.getAttribute('height') || '';\n\n            // プレイヤーを破棄\n            if (this.state.player) {\n                try {\n                    await this.state.player.destroy();\n                    console.log('Player destroyed successfully');\n                } catch (e) {\n                    console.warn('Error destroying player:', e);\n                }\n                this.state.player = null;\n            }\n\n            // 古いiframeを削除（既に destroy で削除されている可能性があるため確認）\n            if (this.iframe.parentElement) {\n                this.iframe.remove();\n                console.log('Old iframe removed');\n            } else {\n                console.log('iframe already removed by player.destroy()');\n            }\n\n            // 新しいiframe要素を作成\n            const newIframe = document.createElement('iframe');\n            newIframe.id = oldId;\n            newIframe.className = oldClassName;\n            newIframe.setAttribute('allow', 'autoplay; fullscreen; picture-in-picture');\n            newIframe.setAttribute('loading', 'lazy');\n\n            // サイズ属性を即座に設定してリサイズを防ぐ\n            if (oldWidth) newIframe.setAttribute('width', oldWidth);\n            if (oldHeight) newIframe.setAttribute('height', oldHeight);\n\n            // 新しいiframeを挿入\n            parent.appendChild(newIframe);\n            this.iframe = newIframe;\n            console.log('iframe element recreated with size:', oldWidth, 'x', oldHeight);\n\n            // マネージャークラスのiframe参照を更新\n            this.videoConfigManager = new VideoConfigManager(this.container, this.iframe, this.config);\n            this.playerInitializer = new PlayerInitializer(this.container, this.iframe);\n\n            // 少し待機してブラウザがDOMを更新するのを待つ\n            await delay(300);\n\n            // 状態をリセット\n            this.state = {\n                player: null,\n                duration: 0,\n                isPlayerReady: false,\n                isDragging: false,\n                startTime: 0,\n                dragStartX: 0,\n                lastDragUpdate: 0,\n                pendingApiCall: null,\n                lastDisplayedAngle: 0\n            };\n\n            this.progressManager.resetTimeout();\n\n            // 再初期化\n            await this.initialize();\n\n        } catch (error) {\n            console.error('Reload failed:', error);\n        } finally {\n            this.isReloading = false;\n            this.uiManager.setReloadLoading(false);\n        }\n    }\n\n    /**\n     * Vimeoプレイヤー初期化\n     */\n    async initializePlayer(): Promise<void> {\n        try {\n            // 初期サイズを設定\n            await this.videoConfigManager.setInitialSizeFromAPI(\n                (progress, message) => {\n                    this.progressManager.updateProgress(progress, message);\n                },\n                () => {\n                    this.progressManager.adjustLoadingOverlaySize();\n                }\n            );\n\n            // 動画URLを構築してiframeを設定\n            this.videoConfigManager.setupVideoPlayer();\n\n            this.progressManager.updateProgress(20, 'Creating player...');\n\n            // iframeが新しいURLをロードするまで待機（リロード時は長めに）\n            if (this.isReloading) {\n                await delay(2000);\n                console.log('Extended delay for reload');\n            } else {\n                await delay(this.config.PLAYER_LOAD_DELAY_MS);\n            }\n\n            // プレイヤーを作成\n            this.state.player = await this.playerInitializer.createPlayer((progress, message) => {\n                this.progressManager.updateProgress(progress, message);\n            });\n\n            // プレイヤーが完全にロードされるまで待機（リロード時はさらに長めに）\n            if (this.isReloading) {\n                await delay(2000);\n                console.log('Extended player load delay for reload');\n            } else {\n                await delay(this.config.PLAYER_LOAD_DELAY_MS);\n            }\n            this.progressManager.updateProgress(60, 'Loading player settings...');\n\n            // プレイヤーの基本情報取得\n            this.state.duration = await this.playerInitializer.getPlayerDuration(\n                this.state.player,\n                this.isReloading,\n                (progress, message) => this.progressManager.updateProgress(progress, message)\n            );\n\n            // 動画のアスペクト比を調整\n            await this.playerInitializer.adjustVideoAspectRatio(\n                this.state.player,\n                () => this.progressManager.adjustLoadingOverlaySize()\n            );\n\n            this.progressManager.updateProgress(75, 'Applying player settings...');\n\n            // プレイヤー設定を適用\n            await this.playerInitializer.applyPlayerSettings(this.state.player);\n\n            // 動画の事前バッファリング（オプショナル）\n            await this.playerInitializer.preloadVideo(\n                this.state.player,\n                this.state.duration,\n                (progress, message) => this.progressManager.updateProgress(progress, message)\n            );\n\n            this.progressManager.updateProgress(90, 'Setting initial state...');\n\n            // 初期状態設定\n            await this.playerInitializer.setInitialPlayerState(this.state.player);\n\n            // 初期角度表示を更新\n            this.uiManager.updateAngle(0);\n\n            this.state.isPlayerReady = true;\n            console.log('Player ready');\n\n            // プログレス完了\n            this.progressManager.updateProgress(100, 'Initialization complete!');\n\n            // ローディングオーバーレイを隠す\n            setTimeout(() => {\n                this.uiManager.hideLoadingOverlay();\n            }, 500);\n\n        } catch (error) {\n            console.error('Player initialization failed:', error);\n\n            const errorMessage = getErrorMessage(error);\n            if (errorMessage.includes('Failed to create Vimeo player')) {\n                this.showError('プレイヤーエラー', 'ビデオプレイヤーを作成できませんでした。接続を確認してリロードしてください。');\n            } else if (errorMessage.includes('Video not found')) {\n                this.showError('ビデオが見つかりません', '指定されたビデオが見つかりませんでした。ビデオIDを確認してください。');\n            } else if (errorMessage.includes('Access denied')) {\n                this.showError('アクセス拒否', 'このビデオは非公開または制限されています。ビデオの権限を確認してください。');\n            } else if (errorMessage.includes('Failed to get video duration')) {\n                this.showError('ビデオ情報の取得に失敗', 'ビデオの長さを取得できませんでした。ネットワーク接続を確認してリロードしてください。');\n            } else {\n                this.showError('初期化エラー', `ビデオプレイヤーの読み込みに失敗しました。<br><br>エラー: ${errorMessage}<br><br>リロードボタンを押して再試行してください。`);\n            }\n\n            this.videoConfigManager.setInitialSizeFallback(() => {\n                this.progressManager.adjustLoadingOverlaySize();\n            });\n            console.log('Error state maintained, loading overlay not hidden');\n        }\n    }\n\n    /**\n     * イベントリスナーの追加\n     */\n    attachEventListeners(): void {\n        // DragHandlerを作成\n        this.dragHandler = new DragHandler(\n            this.container,\n            this.dragOverlay,\n            this.state,\n            this.config,\n            () => this.videoConfigManager.calculatePixelsPerRotation(),\n            (seconds) => this.uiManager.updateAngle(seconds)\n        );\n\n        this.dragHandler.attachEventListeners();\n        window.addEventListener('resize', this.onWindowResize.bind(this));\n    }\n\n    /**\n     * ウィンドウリサイズイベントハンドラー\n     */\n    async onWindowResize(): Promise<void> {\n        const newQuality = this.videoConfigManager.selectVideoQuality();\n        const currentSrc = this.iframe.src;\n\n        if (!currentSrc.includes(`quality=${newQuality}`)) {\n            console.log('Reinitializing player due to quality change:', newQuality);\n            this.state.isPlayerReady = false;\n            await this.initializePlayer();\n        }\n\n        const newPixelsPerRotation = this.videoConfigManager.calculatePixelsPerRotation();\n        console.log('Window resized, new PIXELS_PER_ROTATION:', newPixelsPerRotation);\n    }\n\n    /**\n     * エラー表示（ProgressManagerを使用）\n     */\n    private showError(title: string, message: string): void {\n        this.progressManager.showError(title, message);\n    }\n\n    /**\n     * エラー表示（非推奨：後方互換性のため残す）\n     */\n    private showError_old(title: string, message: string): void {\n        this.uiManager.showError(title, message);\n    }\n\n    /**\n     * クリーンアップ\n     */\n    destroy(): void {\n        if (this.dragHandler) {\n            this.dragHandler.removeEventListeners();\n        }\n        window.removeEventListener('resize', this.onWindowResize.bind(this));\n        console.log('TurntableViewer destroyed');\n    }\n}\n\n// グローバルな初期化済みコンテナを追跡\nif (!window.turntableViewerInstances) {\n    window.turntableViewerInstances = new Set();\n}\n\n// 初期化関数\nfunction initializeTurntableViewers(): void {\n    const containers = document.querySelectorAll('[vimeo-video-id]');\n\n    if (containers.length === 0) {\n        console.warn('No turntable containers found. Make sure elements have vimeo-video-id attribute.');\n        return;\n    }\n\n    console.log(`Found ${containers.length} turntable container(s), checking for new instances...`);\n\n    containers.forEach((container, index) => {\n        try {\n            if (!container.id) {\n                container.id = `turntable-container-${Date.now()}-${index}`;\n                console.log(`Auto-generated ID: ${container.id}`);\n            }\n\n            if (window.turntableViewerInstances.has(container.id)) {\n                console.log(`TurntableViewer already initialized for container: ${container.id}`);\n                return;\n            }\n\n            new TurntableViewer(container.id);\n            window.turntableViewerInstances.add(container.id);\n            console.log(`TurntableViewer initialized for container: ${container.id}`);\n        } catch (error) {\n            console.error(`Failed to initialize TurntableViewer for container ${index}:`, error);\n        }\n    });\n}\n\n// DOMContentLoadedイベントで初期化\ndocument.addEventListener('DOMContentLoaded', initializeTurntableViewers);\n\n// スクリプトが動的に読み込まれた場合にも対応\nif (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', initializeTurntableViewers);\n} else {\n    initializeTurntableViewers();\n}\n\n// ESモジュールとしてクラスをエクスポート\nexport { TurntableViewer };\n\n// グローバルにも公開(後方互換性のため)\nif (typeof window !== 'undefined') {\n    window.TurntableViewer = TurntableViewer;\n}\n"],"names":["ProgressManager","container","iframe","loadingOverlay","loadingText","progressFill","progressText","percentage","text","angleDisplay","iframeWidth","iframeHeight","defaultHeight","now","totalLoadingTime","timeSinceLastProgress","title","message","getErrorMessage","error","delay","ms","resolve","withTimeout","promise","timeoutMs","errorMessage","_","reject","VideoConfigManager","config","htmlWidth","containerWidth","computedWidth","finalWidth","pixelsPerRotation","videoWidth","videoHeight","htmlHeight","finalHeight","area","effectiveArea","devicePixelRatio","effectiveSize","limitedDPR","selectedQuality","_a","quality","screenWidth","availableWidth","params","url","oembedUrl","controller","timeoutId","response","data","aspectRatio","onProgress","onAdjustOverlay","currentWidth","currentHeight","videoInfo","calculatedHeight","calculatedWidth","defaultWidth","videoUrl","PlayerInitializer","player","isReloading","timeout","duration","currentAspectRatio","settings","setting","preloadPoints","i","point","seekTime","actions","action","DragHandler","dragOverlay","state","calculatePixelsPerRotation","onAngleUpdate","deltaX","rotationProgress","timeDelta","currentX","newTime","err","startX","UIManager","angleEl","progressManager","onReload","isLoading","seconds","angle","roundedAngle","wasHidden","vimeoLink","TurntableViewer","containerId","videoId","clockwiseAttr","isClockwise","parent","oldId","oldClassName","oldWidth","oldHeight","e","newIframe","progress","newQuality","newPixelsPerRotation","initializeTurntableViewers","containers","index"],"mappings":"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"}