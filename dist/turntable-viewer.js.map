{"version":3,"file":"turntable-viewer.js","sources":["../src/progress-manager.ts","../src/utils.ts","../src/video-config-manager.ts","../src/player-initializer.ts","../src/drag-handler.ts","../src/ui-manager.ts","../src/turntable-viewer.ts"],"sourcesContent":["/**\n * プログレスバー管理クラス\n * ローディングオーバーレイとプログレスバーの表示・更新・タイムアウト検知を管理\n */\nexport class ProgressManager {\n    private loadingOverlay: HTMLElement;\n    private loadingText: HTMLElement;\n    private progressFill: HTMLElement;\n    private progressText: HTMLElement;\n    private container: HTMLElement;\n    private iframe: HTMLIFrameElement;\n\n    // タイムアウト検知用\n    private loadingStartTime: number | null = null;\n    private lastProgressTime: number = 0;\n    private lastProgressPercentage: number = 0;\n\n    constructor(\n        container: HTMLElement,\n        iframe: HTMLIFrameElement,\n        loadingOverlay: HTMLElement,\n        loadingText: HTMLElement,\n        progressFill: HTMLElement,\n        progressText: HTMLElement\n    ) {\n        this.container = container;\n        this.iframe = iframe;\n        this.loadingOverlay = loadingOverlay;\n        this.loadingText = loadingText;\n        this.progressFill = progressFill;\n        this.progressText = progressText;\n    }\n\n    /**\n     * プログレスバーを更新\n     */\n    updateProgress(percentage: number, text: string | null = null): void {\n        console.log(`Progress update: ${percentage}% - ${text || 'No text'}`);\n\n        if (this.progressFill) {\n            this.progressFill.style.width = `${percentage}%`;\n            console.log(`Progress fill updated to ${percentage}%`);\n        } else {\n            console.warn('Progress fill element not found');\n        }\n\n        if (this.progressText) {\n            this.progressText.textContent = `${Math.round(percentage)}%`;\n        } else {\n            console.warn('Progress text element not found');\n        }\n\n        if (text && this.loadingText) {\n            this.loadingText.textContent = text;\n        }\n\n        // ローディングタイムアウト監視\n        this.checkLoadingTimeout(percentage);\n    }\n\n    /**\n     * ローディングオーバーレイを表示\n     */\n    showLoadingOverlay(): void {\n        if (this.loadingOverlay) {\n            // ローディング中はAngle表示を即座に非表示\n            const angleDisplay = this.container.querySelector('#angle-display') as HTMLElement;\n            if (angleDisplay) {\n                angleDisplay.style.display = 'none';\n            }\n\n            this.loadingOverlay.classList.remove('hidden');\n            this.updateProgress(0, 'Initializing video player...');\n\n            // ローディングオーバーレイのサイズを即座に調整\n            this.adjustLoadingOverlaySize();\n            // 念のため少し遅延しても再調整\n            setTimeout(() => this.adjustLoadingOverlaySize(), 10);\n        }\n    }\n\n    /**\n     * ローディングオーバーレイを隠す\n     */\n    hideLoadingOverlay(): void {\n        if (this.loadingOverlay) {\n            setTimeout(() => {\n                this.loadingOverlay.classList.add('hidden');\n\n                // Angle表示を再表示（存在する場合のみ）\n                const angleDisplay = this.container.querySelector('#angle-display') as HTMLElement;\n                if (angleDisplay) {\n                    angleDisplay.style.display = 'block';\n                    console.log('Angle display made visible after loading');\n                } else {\n                    console.log('Angle display element not found (optional element)');\n                }\n            }, 500); // 少し遅延してスムーズに非表示\n        }\n    }\n\n    /**\n     * ローディングオーバーレイのサイズをiframe要素に合わせて調整\n     */\n    adjustLoadingOverlaySize(): void {\n        if (!this.loadingOverlay || !this.iframe) return;\n\n        // iframeの実際のサイズ（属性値）を取得\n        const iframeWidth = parseInt(this.iframe.getAttribute('width') || '0');\n        const iframeHeight = parseInt(this.iframe.getAttribute('height') || '0');\n\n        // どちらも設定されている場合はそのまま使用\n        if (iframeWidth && iframeHeight) {\n            this.loadingOverlay.style.width = `${iframeWidth}px`;\n            this.loadingOverlay.style.height = `${iframeHeight}px`;\n            console.log(`Adjusted loading overlay size: ${iframeWidth}x${iframeHeight}`);\n        } else {\n            // サイズが未確定の場合はデフォルト値を使用\n            const defaultWidth = 480;\n            const defaultHeight = Math.round(defaultWidth * (9 / 16));\n            this.loadingOverlay.style.width = `${defaultWidth}px`;\n            this.loadingOverlay.style.height = `${defaultHeight}px`;\n            console.log(`Adjusted loading overlay size to default: ${defaultWidth}x${defaultHeight}`);\n        }\n    }\n\n    /**\n     * ローディングタイムアウトをチェック\n     */\n    private checkLoadingTimeout(percentage: number): void {\n        // 初回またはリセット時にタイマー開始\n        if (!this.loadingStartTime) {\n            this.loadingStartTime = Date.now();\n            this.lastProgressTime = Date.now();\n            this.lastProgressPercentage = percentage;\n            return;\n        }\n\n        const now = Date.now();\n        const totalLoadingTime = now - this.loadingStartTime;\n        const timeSinceLastProgress = now - this.lastProgressTime;\n\n        // プログレスが進んだ場合は時間を更新\n        if (percentage > this.lastProgressPercentage) {\n            this.lastProgressTime = now;\n            this.lastProgressPercentage = percentage;\n            return;\n        }\n\n        // 30秒間プログレスが進んでいない場合、または総ローディング時間が60秒を超えた場合\n        const STALLED_TIMEOUT = 30000; // 30秒\n        const TOTAL_TIMEOUT = 60000;   // 60秒\n\n        if (timeSinceLastProgress > STALLED_TIMEOUT || totalLoadingTime > TOTAL_TIMEOUT) {\n            console.warn(`Loading timeout detected. Stalled: ${timeSinceLastProgress}ms, Total: ${totalLoadingTime}ms`);\n\n            // ローディングが停止していることを示す\n            if (this.loadingText) {\n                this.loadingText.textContent = 'ローディングが停止しました - リロードボタンを押してください';\n                this.loadingText.style.color = '#ff6b6b';\n            }\n\n            // タイムアウト検出をリセット（重複表示を防ぐ）\n            this.loadingStartTime = null;\n        }\n    }\n\n    /**\n     * タイムアウトタイマーをリセット\n     */\n    resetTimeout(): void {\n        this.loadingStartTime = null;\n        this.lastProgressTime = 0;\n        this.lastProgressPercentage = 0;\n    }\n\n    /**\n     * エラー表示（ローディングオーバーレイをエラー表示に変更）\n     */\n    showError(title: string, message: string): void {\n        if (!this.loadingOverlay) return;\n\n        // ローディングオーバーレイをエラー表示に変更\n        this.loadingOverlay.innerHTML = `\n                <div class=\"loading-content\">\n                    <div class=\"loading-text\" style=\"color: #ff6b6b;\">${title}</div>\n                    <div style=\"color: #ffa8a8; font-size: 11px; margin-top: 8px; line-height: 1.4;\">\n                        ${message}\n                    </div>\n                </div>\n            `;\n        this.loadingOverlay.style.display = 'flex';\n        this.loadingOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';\n\n        console.error(`${title}: ${message}`);\n    }\n}\n","/**\n * 共通ユーティリティ関数\n */\n\n/**\n * エラーメッセージを取得\n */\nexport function getErrorMessage(error: unknown): string {\n    if (error instanceof Error) return error.message;\n    return String(error);\n}\n\n/**\n * 遅延関数\n */\nexport function delay(ms: number): Promise<void> {\n    return new Promise(resolve => setTimeout(resolve, ms));\n}\n\n/**\n * デバウンス関数\n */\nexport function debounce<T extends (...args: any[]) => any>(\n    func: T,\n    wait: number\n): (...args: Parameters<T>) => void {\n    let timeout: ReturnType<typeof setTimeout> | undefined;\n    return function executedFunction(...args: Parameters<T>) {\n        const later = () => {\n            clearTimeout(timeout);\n            func(...args);\n        };\n        clearTimeout(timeout);\n        timeout = setTimeout(later, wait);\n    };\n}\n\n/**\n * タイムアウト付きPromise実行\n */\nexport function withTimeout<T = any>(\n    promise: Promise<T>,\n    timeoutMs: number,\n    errorMessage: string\n): Promise<T> {\n    return Promise.race([\n        promise,\n        new Promise<T>((_, reject) =>\n            setTimeout(() => reject(new Error(errorMessage || 'Operation timed out')), timeoutMs)\n        )\n    ]);\n}\n","import type { TurntableConfig, VideoInfo } from './types';\nimport { getErrorMessage, withTimeout, delay } from './utils';\n\n/**\n * 動画設定・品質・URL構築を管理するクラス\n */\nexport class VideoConfigManager {\n    private container: HTMLElement;\n    private iframe: HTMLIFrameElement;\n    private config: TurntableConfig;\n\n    constructor(container: HTMLElement, iframe: HTMLIFrameElement, config: TurntableConfig) {\n        this.container = container;\n        this.iframe = iframe;\n        this.config = config;\n    }\n\n    /**\n     * 表示サイズに基づいてPIXELS_PER_ROTATIONを動的に計算\n     */\n    calculatePixelsPerRotation(): number {\n        const htmlWidth = parseInt(this.iframe.getAttribute('width') || '0');\n        const containerWidth = this.container.clientWidth || 0;\n        const iframeWidth = this.iframe.clientWidth || 0;\n        const computedWidth = Math.max(containerWidth, iframeWidth) || 0;\n\n        const finalWidth = htmlWidth || computedWidth || 320;\n\n        console.log(`Container width for calculation: ${finalWidth}px (html: ${htmlWidth}, container: ${containerWidth}, iframe: ${iframeWidth})`);\n\n        const basePixels = 1200;\n        const baseScreenSize = 640;\n\n        let pixelsPerRotation = (finalWidth / baseScreenSize) * basePixels;\n\n        if (finalWidth <= 480) {\n            pixelsPerRotation *= 1.2;\n        }\n\n        pixelsPerRotation = Math.max(250, Math.min(3000, pixelsPerRotation));\n\n        console.log(`Calculated PIXELS_PER_ROTATION: ${Math.round(pixelsPerRotation)} for width: ${finalWidth}px`);\n        return Math.round(pixelsPerRotation);\n    }\n\n    /**\n     * 表示サイズに応じた動画品質選択\n     */\n    selectVideoQuality(): string {\n        const videoWidth = parseInt(this.container.getAttribute('video-width') || '0');\n        const videoHeight = parseInt(this.container.getAttribute('video-height') || '0');\n        const htmlWidth = parseInt(this.iframe.getAttribute('width') || '0');\n        const htmlHeight = parseInt(this.iframe.getAttribute('height') || '0');\n        const computedWidth = this.iframe.clientWidth || this.container.clientWidth || 0;\n        const computedHeight = this.iframe.clientHeight || this.container.clientHeight || 0;\n\n        const finalWidth = videoWidth || htmlWidth || computedWidth || 480;\n        const finalHeight = videoHeight || htmlHeight || finalWidth;\n\n        const area = finalWidth * finalHeight;\n        const effectiveArea = Math.sqrt(area);\n\n        const devicePixelRatio = window.devicePixelRatio || 1;\n\n        let effectiveSize;\n        if ((htmlWidth && htmlHeight) || (videoWidth && videoHeight)) {\n            const limitedDPR = Math.min(devicePixelRatio, 1.5);\n            effectiveSize = effectiveArea * limitedDPR;\n        } else {\n            effectiveSize = effectiveArea * devicePixelRatio;\n        }\n\n        let selectedQuality = '240p';\n        if (effectiveSize <= 240) {\n            selectedQuality = '240p';\n        } else if (effectiveSize <= 360) {\n            selectedQuality = '360p';\n        } else if (effectiveSize <= 480) {\n            selectedQuality = '540p';\n        } else if (effectiveSize <= 960) {\n            selectedQuality = '720p';\n        } else if (effectiveSize <= 1280) {\n            selectedQuality = '1080p';\n        } else if (effectiveSize <= 1920) {\n            selectedQuality = '2k';\n        } else {\n            selectedQuality = '4k';\n        }\n\n        console.log(`Selected quality: ${selectedQuality} for effective size: ${effectiveSize}px (${finalWidth}x${finalHeight})`);\n        return selectedQuality;\n    }\n\n    /**\n     * 動画URLを構築\n     */\n    buildVideoUrl(): string {\n        const quality = this.selectVideoQuality();\n\n        const videoWidth = parseInt(this.container.getAttribute('video-width') || '0');\n        const videoHeight = parseInt(this.container.getAttribute('video-height') || '0');\n        const htmlWidth = parseInt(this.iframe.getAttribute('width') || '0');\n        const htmlHeight = parseInt(this.iframe.getAttribute('height') || '0');\n\n        let finalWidth = videoWidth || htmlWidth || 480;\n        let finalHeight = videoHeight || htmlHeight || finalWidth;\n\n        const screenWidth = window.innerWidth || document.documentElement.clientWidth;\n        if (screenWidth <= 768) {\n            const containerWidth = this.container.clientWidth || this.container.parentElement?.clientWidth || screenWidth;\n            const availableWidth = Math.floor(containerWidth * 0.9);\n            if (availableWidth > 200) {\n                finalWidth = availableWidth;\n                finalHeight = availableWidth;\n            }\n        }\n\n        this.iframe.setAttribute('width', finalWidth.toString());\n        this.iframe.setAttribute('height', finalHeight.toString());\n\n        if (screenWidth <= 768) {\n            this.iframe.style.width = finalWidth + 'px';\n            this.iframe.style.height = finalHeight + 'px';\n            this.iframe.style.maxWidth = 'none';\n            this.iframe.style.display = 'block';\n            console.log(`Applied direct CSS styles: ${finalWidth}x${finalHeight}`);\n        }\n\n        const params = new URLSearchParams({\n            background: '1',\n            byline: '0',\n            portrait: '0',\n            title: '0',\n            speed: '0',\n            transparent: '1',\n            gesture: 'media',\n            autopause: '0',\n            muted: '1',\n            loop: '1',\n            controls: '0',\n            quality: quality,\n            responsive: '0',\n            dnt: '1'\n        });\n\n        const url = `https://player.vimeo.com/video/${this.config.videoId}?${params.toString()}`;\n        console.log(`Video URL set: ${url} (Size: ${finalWidth}x${finalHeight}, Screen: ${screenWidth})`);\n        return url;\n    }\n\n    /**\n     * Vimeo oEmbed APIから動画情報を事前取得\n     */\n    async getVideoInfoFromAPI(): Promise<VideoInfo> {\n        try {\n            if (!/^\\d+$/.test(this.config.videoId)) {\n                throw new Error('Invalid video ID format for API call');\n            }\n\n            const oembedUrl = `https://vimeo.com/api/oembed.json?url=https://vimeo.com/${this.config.videoId}`;\n            console.log(`Fetching video info from: ${oembedUrl}`);\n\n            await delay(Math.random() * 500);\n\n            const controller = new AbortController();\n            const timeoutId = setTimeout(() => controller.abort(), 10000);\n\n            const response = await fetch(oembedUrl, {\n                signal: controller.signal,\n                referrerPolicy: 'no-referrer',\n                headers: {\n                    'Accept': 'application/json'\n                }\n            });\n\n            clearTimeout(timeoutId);\n\n            if (!response.ok) {\n                if (response.status === 404) {\n                    throw new Error(`Video not found (ID: ${this.config.videoId}). Please check the video ID.`);\n                } else if (response.status === 403) {\n                    throw new Error(`Access denied to video (ID: ${this.config.videoId}). Video may be private.`);\n                } else if (response.status >= 500) {\n                    throw new Error(`Vimeo server error (status: ${response.status}). Please try again later.`);\n                } else {\n                    throw new Error(`HTTP error! status: ${response.status}`);\n                }\n            }\n\n            const data = await response.json();\n\n            if (!data || typeof data !== 'object') {\n                throw new Error('Invalid API response format');\n            }\n\n            if (!data.width || !data.height || data.width <= 0 || data.height <= 0) {\n                throw new Error('Invalid video dimensions in API response');\n            }\n\n            const aspectRatio = data.height / data.width;\n\n            console.log(`API Video dimensions: ${data.width}x${data.height}, aspect ratio: ${aspectRatio.toFixed(3)}`);\n\n            return {\n                width: data.width,\n                height: data.height,\n                aspectRatio: aspectRatio,\n                title: data.title || 'Untitled Video'\n            };\n        } catch (error) {\n            if ((error as any).name === 'AbortError') {\n                console.warn('API request timed out, using default aspect ratio');\n            } else {\n                console.warn('Could not fetch video info from API:', getErrorMessage(error));\n            }\n\n            return {\n                width: 1920,\n                height: 1080,\n                aspectRatio: 9 / 16,\n                title: 'Untitled Video'\n            };\n        }\n    }\n\n    /**\n     * 初期サイズを設定（API情報から）\n     */\n    async setInitialSizeFromAPI(\n        onProgress?: (progress: number, message: string) => void,\n        onAdjustOverlay?: () => void\n    ): Promise<void> {\n        try {\n            const currentWidth = parseInt(this.iframe.getAttribute('width') || '0');\n            const currentHeight = parseInt(this.iframe.getAttribute('height') || '0');\n\n            this.iframe.style.visibility = 'hidden';\n\n            if (currentWidth && currentHeight) {\n                console.log(`Both width and height specified: ${currentWidth}x${currentHeight}`);\n                this.container.classList.add('initialized');\n                this.iframe.style.visibility = 'visible';\n                this.iframe.classList.add('size-ready');\n                console.log('Container and iframe ready with fixed size');\n                onAdjustOverlay?.();\n                return;\n            }\n\n            if (currentWidth || currentHeight) {\n                onProgress?.(5, 'Getting video information...');\n\n                const videoInfo = await this.getVideoInfoFromAPI();\n\n                if (currentWidth && !currentHeight) {\n                    const calculatedHeight = Math.round(currentWidth * videoInfo.aspectRatio);\n                    this.iframe.setAttribute('height', calculatedHeight.toString());\n                    console.log(`Set height from width: ${currentWidth}x${calculatedHeight} (aspect ratio: ${videoInfo.aspectRatio.toFixed(3)})`);\n                } else if (currentHeight && !currentWidth) {\n                    const calculatedWidth = Math.round(currentHeight / videoInfo.aspectRatio);\n                    this.iframe.setAttribute('width', calculatedWidth.toString());\n                    console.log(`Set width from height: ${calculatedWidth}x${currentHeight} (aspect ratio: ${videoInfo.aspectRatio.toFixed(3)})`);\n                }\n\n                this.container.classList.add('initialized');\n                this.iframe.style.visibility = 'visible';\n                this.iframe.classList.add('size-ready');\n                console.log('Container and iframe size ready, made visible');\n\n                onAdjustOverlay?.();\n            } else {\n                const defaultWidth = 480;\n                onProgress?.(5, 'Getting video information...');\n\n                const videoInfo = await this.getVideoInfoFromAPI();\n                const calculatedHeight = Math.round(defaultWidth * videoInfo.aspectRatio);\n\n                this.iframe.setAttribute('width', defaultWidth.toString());\n                this.iframe.setAttribute('height', calculatedHeight.toString());\n                console.log(`Set default size: ${defaultWidth}x${calculatedHeight} (aspect ratio: ${videoInfo.aspectRatio.toFixed(3)})`);\n\n                this.container.classList.add('initialized');\n                this.iframe.style.visibility = 'visible';\n                this.iframe.classList.add('size-ready');\n                console.log('Container and iframe size ready with default size');\n\n                onAdjustOverlay?.();\n            }\n\n            console.log('setInitialSizeFromAPI completed');\n        } catch (error) {\n            console.warn('Could not set initial size from API:', error);\n            this.setInitialSizeFallback(onAdjustOverlay);\n        }\n    }\n\n    /**\n     * 初期サイズを設定（フォールバック版）\n     */\n    setInitialSizeFallback(onAdjustOverlay?: () => void): void {\n        try {\n            const currentWidth = parseInt(this.iframe.getAttribute('width') || '0');\n            const currentHeight = parseInt(this.iframe.getAttribute('height') || '0');\n\n            if (currentWidth && currentHeight) {\n                console.log(`Fallback: Both width and height specified: ${currentWidth}x${currentHeight}`);\n            } else if (currentWidth && !currentHeight) {\n                const defaultHeight = Math.round(currentWidth * (9 / 16));\n                this.iframe.setAttribute('height', defaultHeight.toString());\n                console.log(`Fallback: Set height from width: ${currentWidth}x${defaultHeight} (16:9 default aspect ratio)`);\n            } else if (currentHeight && !currentWidth) {\n                const defaultWidth = Math.round(currentHeight / (9 / 16));\n                this.iframe.setAttribute('width', defaultWidth.toString());\n                console.log(`Fallback: Set width from height: ${defaultWidth}x${currentHeight} (16:9 default aspect ratio)`);\n            } else {\n                const defaultWidth = 480;\n                const defaultHeight = Math.round(defaultWidth * (9 / 16));\n                this.iframe.setAttribute('width', defaultWidth.toString());\n                this.iframe.setAttribute('height', defaultHeight.toString());\n                console.log(`Fallback: Set default size: ${defaultWidth}x${defaultHeight} (16:9 default aspect ratio)`);\n            }\n\n            this.container.classList.add('initialized');\n            this.iframe.style.visibility = 'visible';\n            this.iframe.classList.add('size-ready');\n            console.log('Container and iframe size ready (fallback), made visible');\n\n            onAdjustOverlay?.();\n        } catch (error) {\n            console.warn('Could not set fallback initial size:', error);\n        }\n    }\n\n    /**\n     * 動画プレイヤーのセットアップ\n     */\n    setupVideoPlayer(): void {\n        const videoUrl = this.buildVideoUrl();\n        this.iframe.src = videoUrl;\n    }\n}\n","import type { TurntableState } from './types';\nimport { getErrorMessage, withTimeout, delay } from './utils';\n\n/**\n * プレイヤー初期化と事前ロードを管理するクラス\n */\nexport class PlayerInitializer {\n    private iframe: HTMLIFrameElement;\n    private container: HTMLElement;\n\n    constructor(container: HTMLElement, iframe: HTMLIFrameElement) {\n        this.container = container;\n        this.iframe = iframe;\n    }\n\n    /**\n     * Vimeoプレイヤーを作成\n     */\n    async createPlayer(onProgress?: (progress: number, message: string) => void): Promise<any> {\n        try {\n            onProgress?.(40, 'Connecting to player...');\n            // @ts-ignore - VimeoはグローバルにCDNから読み込まれている\n            const player = new Vimeo.Player(this.iframe);\n            return player;\n        } catch (error) {\n            throw new Error(`Failed to create Vimeo player: ${getErrorMessage(error)}`);\n        }\n    }\n\n    /**\n     * プレイヤーの基本情報取得\n     */\n    async getPlayerDuration(player: any, isReloading: boolean = false, onProgress?: (progress: number, message: string) => void): Promise<number> {\n        onProgress?.(60, 'Loading player settings...');\n\n        // リロード時はタイムアウトを長くする\n        const timeout = isReloading ? 15000 : 10000;\n        const duration = await withTimeout(\n            player.getDuration(),\n            timeout,\n            'Failed to get video duration'\n        );\n        console.log('Duration:', duration);\n\n        if (!duration || duration <= 0) {\n            throw new Error('Invalid video duration received');\n        }\n\n        return duration;\n    }\n\n    /**\n     * 動画のアスペクト比を調整（プレイヤー情報から詳細確認）\n     */\n    async adjustVideoAspectRatio(player: any, onAdjustOverlay?: () => void): Promise<void> {\n        try {\n            console.log('Getting video dimensions...');\n            const videoWidth = await withTimeout(\n                player.getVideoWidth(),\n                3000,\n                'Failed to get video width'\n            );\n            const videoHeight = await withTimeout(\n                player.getVideoHeight(),\n                3000,\n                'Failed to get video height'\n            );\n            const aspectRatio = videoHeight / videoWidth;\n\n            console.log(`Player Video dimensions: ${videoWidth}x${videoHeight}, aspect ratio: ${aspectRatio.toFixed(3)}`);\n\n            const currentWidth = parseInt(this.iframe.getAttribute('width') || '480');\n            const currentHeight = parseInt(this.iframe.getAttribute('height') || '480');\n            const currentAspectRatio = currentHeight / currentWidth;\n            const specifiedVideoHeight = parseInt(this.container.getAttribute('video-height') || '0');\n\n            if (!specifiedVideoHeight && Math.abs(currentAspectRatio - aspectRatio) > 0.01) {\n                const calculatedHeight = Math.round(currentWidth * aspectRatio);\n                this.iframe.setAttribute('height', calculatedHeight.toString());\n                console.log(`Fine-tuned iframe size: ${currentWidth}x${calculatedHeight} (aspect ratio: ${aspectRatio.toFixed(3)})`);\n\n                onAdjustOverlay?.();\n            } else {\n                console.log('Aspect ratio already correct, no adjustment needed');\n            }\n        } catch (error) {\n            console.warn('Could not get video dimensions, keeping current size:', getErrorMessage(error));\n            onAdjustOverlay?.();\n        }\n    }\n\n    /**\n     * プレイヤー設定を個別にエラーハンドリング付きで適用\n     */\n    async applyPlayerSettings(player: any, onProgress?: (progress: number, message: string) => void): Promise<void> {\n        onProgress?.(75, 'Applying player settings...');\n\n        const settings = [\n            {\n                name: 'loop',\n                action: () => player.setLoop(true),\n                fallback: () => console.warn('Could not set loop mode')\n            },\n            {\n                name: 'volume',\n                action: () => player.setVolume(0),\n                fallback: () => console.warn('Could not set volume')\n            }\n        ];\n\n        for (const setting of settings) {\n            try {\n                await withTimeout(setting.action(), 3000, `Failed to set ${setting.name}`);\n                console.log(`Successfully set ${setting.name}`);\n            } catch (error) {\n                console.warn(`Setting ${setting.name} failed:`, getErrorMessage(error));\n                setting.fallback();\n            }\n        }\n    }\n\n    /**\n     * 動画の事前ロード（失敗しても続行可能）\n     */\n    async preloadVideo(player: any, duration: number, onProgress?: (progress: number, message: string) => void): Promise<boolean> {\n        try {\n            onProgress?.(85, 'Buffering video...');\n            console.log('Starting video buffer preload...');\n\n            // 再生せずにseekだけでバッファリング（ブラウザの自動再生ブロックを回避）\n            const preloadPoints = [0, 0.5];\n            for (let i = 0; i < preloadPoints.length; i++) {\n                const point = preloadPoints[i];\n                const seekTime = duration * point;\n                await withTimeout(\n                    player.setCurrentTime(seekTime),\n                    5000,\n                    `Preload seek timeout at ${point * 100}%`\n                );\n                await delay(300);\n\n                onProgress?.(85 + (i + 1) * 2, `Buffering ${Math.round(point * 100)}%...`);\n            }\n\n            await withTimeout(player.setCurrentTime(0), 5000, 'Preload final seek timeout');\n\n            console.log('Video buffer preload completed');\n            return true;\n        } catch (error) {\n            // バッファリングはオプショナルなので、失敗しても問題ない\n            console.log('Video buffer preload skipped:', getErrorMessage(error));\n            return false;\n        }\n    }\n\n    /**\n     * 初期プレイヤー状態の設定\n     */\n    async setInitialPlayerState(player: any, onProgress?: (progress: number, message: string) => void): Promise<void> {\n        onProgress?.(90, 'Setting initial state...');\n\n        // playはブラウザの自動再生ポリシーでブロックされる可能性があるが、\n        // pauseとseekが成功すればウィジェットは機能する\n        const actions = [\n            { name: 'play', action: () => player.play(), optional: true },\n            { name: 'pause', action: () => player.pause(), optional: false },\n            { name: 'seek to start', action: () => player.setCurrentTime(0), optional: false }\n        ];\n\n        for (const action of actions) {\n            try {\n                await withTimeout(action.action(), 3000, `Failed to ${action.name}`);\n                console.log(`Successfully executed: ${action.name}`);\n            } catch (error) {\n                if (action.optional) {\n                    // オプショナルな操作（play等）の失敗は通常動作\n                    console.log(`${action.name} skipped (likely blocked by browser autoplay policy)`);\n                } else {\n                    // 必須の操作（pause/seek）の失敗は警告\n                    console.warn(`Action ${action.name} failed:`, getErrorMessage(error));\n                }\n            }\n        }\n    }\n}\n","import type { TurntableConfig, TurntableState } from './types';\n\n/**\n * ドラッグ操作とイベント処理を管理するクラス\n */\nexport class DragHandler {\n    private container: HTMLElement;\n    private dragOverlay: HTMLElement;\n    private state: TurntableState;\n    private config: TurntableConfig;\n    private calculatePixelsPerRotation: () => number;\n    private onAngleUpdate: (seconds: number) => void;\n\n    // バインド済みのイベントハンドラー\n    private boundMouseDown: (e: MouseEvent) => Promise<void>;\n    private boundMouseMove: (e: MouseEvent) => void;\n    private boundMouseUp: () => void;\n    private boundTouchStart: (e: TouchEvent) => Promise<void>;\n    private boundTouchMove: (e: TouchEvent) => void;\n    private boundTouchEnd: (e: TouchEvent) => void;\n\n    constructor(\n        container: HTMLElement,\n        dragOverlay: HTMLElement,\n        state: TurntableState,\n        config: TurntableConfig,\n        calculatePixelsPerRotation: () => number,\n        onAngleUpdate: (seconds: number) => void\n    ) {\n        this.container = container;\n        this.dragOverlay = dragOverlay;\n        this.state = state;\n        this.config = config;\n        this.calculatePixelsPerRotation = calculatePixelsPerRotation;\n        this.onAngleUpdate = onAngleUpdate;\n\n        // イベントハンドラーをバインド\n        this.boundMouseDown = this.onMouseDown.bind(this);\n        this.boundMouseMove = this.onMouseMove.bind(this);\n        this.boundMouseUp = this.onMouseUp.bind(this);\n        this.boundTouchStart = this.onTouchStart.bind(this);\n        this.boundTouchMove = this.onTouchMove.bind(this);\n        this.boundTouchEnd = this.onTouchEnd.bind(this);\n    }\n\n    /**\n     * イベントリスナーを追加\n     */\n    attachEventListeners(): void {\n        this.dragOverlay.addEventListener('mousedown', this.boundMouseDown);\n        this.dragOverlay.addEventListener('touchstart', this.boundTouchStart, { passive: false });\n    }\n\n    /**\n     * イベントリスナーを削除\n     */\n    removeEventListeners(): void {\n        this.dragOverlay.removeEventListener('mousedown', this.boundMouseDown);\n        this.dragOverlay.removeEventListener('touchstart', this.boundTouchStart);\n        document.removeEventListener('mousemove', this.boundMouseMove);\n        document.removeEventListener('mouseup', this.boundMouseUp);\n        document.removeEventListener('touchmove', this.boundTouchMove);\n        document.removeEventListener('touchend', this.boundTouchEnd);\n    }\n\n    /**\n     * 新しい再生時間を計算（ループ対応）\n     */\n    private calculateNewTime(deltaX: number): number {\n        const sensitivityFactor = 0.9;\n        const pixelsPerRotation = this.calculatePixelsPerRotation();\n        const adjustedDelta = deltaX * sensitivityFactor;\n        const rotationProgress = adjustedDelta / pixelsPerRotation;\n\n        const timeDelta = this.config.isClockwise\n            ? -rotationProgress * this.state.duration\n            : rotationProgress * this.state.duration;\n\n        let newTime = this.state.startTime + timeDelta;\n\n        return ((newTime % this.state.duration) + this.state.duration) % this.state.duration;\n    }\n\n    /**\n     * ドラッグ操作の共通処理\n     */\n    private handleDragMove(currentX: number): void {\n        if (!this.state.isDragging || !this.state.isPlayerReady) return;\n\n        if (this.state.startTime === undefined || this.state.startTime === null) return;\n        if (this.state.dragStartX === undefined || this.state.dragStartX === null) return;\n\n        const deltaX = currentX - this.state.dragStartX;\n\n        if (Math.abs(deltaX) > 2000) {\n            console.warn('Extreme deltaX detected, ignoring:', deltaX);\n            return;\n        }\n\n        const newTime = this.calculateNewTime(deltaX);\n\n        // UI更新を即座に実行\n        this.onAngleUpdate(newTime);\n\n        const now = performance.now();\n        const shouldThrottle = now - this.state.lastDragUpdate < 100;\n\n        if (!shouldThrottle) {\n            this.state.lastDragUpdate = now;\n\n            if (this.state.pendingApiCall) {\n                cancelAnimationFrame(this.state.pendingApiCall);\n            }\n\n            this.state.pendingApiCall = requestAnimationFrame(() => {\n                if (this.state.isDragging && this.state.isPlayerReady) {\n                    this.state.player?.setCurrentTime(newTime).catch((err: any) => {\n                        console.warn('Vimeo API call ignored due to performance:', err);\n                    });\n                }\n                this.state.pendingApiCall = null;\n            });\n        }\n    }\n\n    /**\n     * ドラッグ開始の共通処理\n     */\n    private async handleDragStart(startX: number): Promise<boolean> {\n        if (!this.state.isPlayerReady) return false;\n\n        this.state.isDragging = false;\n        this.state.dragStartX = startX;\n        this.dragOverlay.style.cursor = 'grabbing';\n\n        try {\n            this.state.startTime = await this.state.player.getCurrentTime();\n            this.state.isDragging = true;\n\n            this.dragOverlay.classList.add('dragging');\n            this.container.classList.add('dragging');\n\n            this.state.dragStartX = startX;\n\n            console.log('Drag started at time:', this.state.startTime, 'position:', startX);\n            return true;\n        } catch (error) {\n            console.error('Failed to get current time:', error);\n            this.state.isDragging = false;\n            this.dragOverlay.classList.remove('dragging');\n            this.container.classList.remove('dragging');\n            this.dragOverlay.style.cursor = 'grab';\n            return false;\n        }\n    }\n\n    /**\n     * ドラッグ終了の共通処理\n     */\n    private handleDragEnd(): void {\n        if (!this.state.isDragging) return;\n\n        this.state.isDragging = false;\n\n        this.dragOverlay.classList.remove('dragging');\n        this.container.classList.remove('dragging');\n\n        if (this.state.pendingApiCall) {\n            cancelAnimationFrame(this.state.pendingApiCall);\n            this.state.pendingApiCall = null;\n        }\n\n        this.dragOverlay.style.cursor = 'grab';\n        this.state.player?.pause();\n    }\n\n    /**\n     * マウスダウンイベントハンドラー\n     */\n    private async onMouseDown(e: MouseEvent): Promise<void> {\n        if (this.state.isDragging) return;\n\n        const success = await this.handleDragStart(e.clientX);\n        if (!success) return;\n\n        document.addEventListener('mousemove', this.boundMouseMove);\n        document.addEventListener('mouseup', this.boundMouseUp);\n        e.preventDefault();\n    }\n\n    /**\n     * マウスムーブイベントハンドラー\n     */\n    private onMouseMove(e: MouseEvent): void {\n        this.handleDragMove(e.clientX);\n    }\n\n    /**\n     * マウスアップイベントハンドラー\n     */\n    private onMouseUp(): void {\n        this.handleDragEnd();\n        document.removeEventListener('mousemove', this.boundMouseMove);\n        document.removeEventListener('mouseup', this.boundMouseUp);\n    }\n\n    /**\n     * タッチスタートイベントハンドラー\n     */\n    private async onTouchStart(e: TouchEvent): Promise<void> {\n        if (this.state.isDragging) return;\n\n        e.preventDefault();\n        e.stopPropagation();\n\n        const success = await this.handleDragStart(e.touches[0].clientX);\n        if (!success) return;\n\n        document.addEventListener('touchmove', this.boundTouchMove, { passive: false });\n        document.addEventListener('touchend', this.boundTouchEnd, { passive: false });\n    }\n\n    /**\n     * タッチムーブイベントハンドラー\n     */\n    private onTouchMove(e: TouchEvent): void {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this.handleDragMove(e.touches[0].clientX);\n    }\n\n    /**\n     * タッチエンドイベントハンドラー\n     */\n    private onTouchEnd(e: TouchEvent): void {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this.handleDragEnd();\n        document.removeEventListener('touchmove', this.boundTouchMove);\n        document.removeEventListener('touchend', this.boundTouchEnd);\n    }\n}\n","import type { TurntableConfig, TurntableState } from './types';\nimport { ProgressManager } from './progress-manager';\n\n/**\n * UI更新を管理するクラス（角度表示、リロードボタン、Vimeoリンク）\n */\nexport class UIManager {\n    private container: HTMLElement;\n    private iframe: HTMLIFrameElement;\n    private angleEl: HTMLElement | null;\n    private angleDisplay: HTMLElement | null;\n    private reloadButton: HTMLButtonElement;\n    private config: TurntableConfig;\n    private state: TurntableState;\n    private progressManager: ProgressManager;\n    private onReload: () => Promise<void>;\n\n    constructor(\n        container: HTMLElement,\n        iframe: HTMLIFrameElement,\n        angleEl: HTMLElement | null,\n        angleDisplay: HTMLElement | null,\n        config: TurntableConfig,\n        state: TurntableState,\n        progressManager: ProgressManager,\n        onReload: () => Promise<void>\n    ) {\n        this.container = container;\n        this.iframe = iframe;\n        this.angleEl = angleEl;\n        this.angleDisplay = angleDisplay;\n        this.config = config;\n        this.state = state;\n        this.progressManager = progressManager;\n        this.onReload = onReload;\n\n        // リロードボタンを作成\n        this.reloadButton = document.createElement('button');\n        this.createReloadButton();\n    }\n\n    /**\n     * リロードボタンを作成\n     */\n    private createReloadButton(): void {\n        this.reloadButton.className = 'reload-button';\n        this.reloadButton.title = 'ビデオを再読み込み';\n\n        this.reloadButton.innerHTML = `\n            <svg class=\"reload-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\n                <path d=\"M23 4v6h-6\"/>\n                <path d=\"M20.49 15a9 9 0 1 1-2.12-9.36L23 10\"/>\n            </svg>\n        `;\n\n        this.reloadButton.addEventListener('click', () => {\n            this.onReload();\n        });\n\n        this.container.appendChild(this.reloadButton);\n    }\n\n    /**\n     * リロードボタンを表示\n     */\n    showReloadButton(): void {\n        if (this.reloadButton) {\n            this.reloadButton.style.display = 'flex';\n        }\n    }\n\n    /**\n     * リロードボタンを非表示\n     */\n    hideReloadButton(): void {\n        if (this.reloadButton) {\n            this.reloadButton.style.display = 'none';\n        }\n    }\n\n    /**\n     * リロード処理のローディング状態を設定\n     */\n    setReloadLoading(isLoading: boolean): void {\n        if (isLoading) {\n            this.reloadButton.classList.add('loading');\n        } else {\n            this.reloadButton.classList.remove('loading');\n        }\n    }\n\n    /**\n     * 角度表示更新\n     */\n    updateAngle(seconds: number): void {\n        let angle;\n\n        if (this.config.isClockwise) {\n            angle = (seconds / this.state.duration) * 360;\n        } else {\n            angle = 360 - (seconds / this.state.duration) * 360;\n        }\n\n        angle = angle % 360;\n        if (angle < 0) angle += 360;\n\n        if (!this.angleEl) return;\n\n        const roundedAngle = Math.round(angle);\n        if (this.state.isDragging) {\n            this.angleEl.textContent = roundedAngle.toString();\n            this.state.lastDisplayedAngle = roundedAngle;\n        } else {\n            if (this.state.lastDisplayedAngle !== roundedAngle) {\n                this.angleEl.textContent = roundedAngle.toString();\n                this.state.lastDisplayedAngle = roundedAngle;\n            }\n        }\n    }\n\n    /**\n     * 角度表示の位置を調整\n     */\n    adjustAngleDisplayPosition(): void {\n        if (!this.angleDisplay || !this.iframe) {\n            console.log('angleDisplay or iframe not found, skipping position adjustment');\n            return;\n        }\n\n        const wasHidden = this.angleDisplay.style.display === 'none';\n        if (wasHidden) {\n            this.angleDisplay.style.visibility = 'hidden';\n            this.angleDisplay.style.display = 'block';\n        }\n\n        console.log('Angle display positioned at bottom center via CSS');\n\n        if (wasHidden) {\n            this.angleDisplay.style.display = 'none';\n            this.angleDisplay.style.visibility = 'visible';\n        }\n    }\n\n    /**\n     * 角度表示を表示\n     */\n    showAngleDisplay(): void {\n        if (this.angleDisplay) {\n            this.adjustAngleDisplayPosition();\n            this.angleDisplay.style.display = 'block';\n            console.log('Angle display enabled after successful initialization and position adjustment');\n        }\n    }\n\n    /**\n     * 角度表示を非表示\n     */\n    hideAngleDisplay(): void {\n        if (this.angleDisplay) {\n            this.angleDisplay.style.display = 'none';\n        }\n    }\n\n    /**\n     * Vimeoリンクを表示\n     */\n    showVimeoLink(): void {\n        const vimeoLink = (this.container.parentNode?.querySelector('.vimeo-link') ||\n            this.container.querySelector('.vimeo-link')) as HTMLAnchorElement;\n        if (vimeoLink && this.config.videoId) {\n            if (!/^\\d+$/.test(this.config.videoId)) {\n                console.warn('Invalid video ID format detected, skipping Vimeo link generation');\n                return;\n            }\n\n            vimeoLink.href = `https://vimeo.com/${this.config.videoId}`;\n\n            if (this.iframe) {\n                const videoWidth = this.iframe.offsetWidth;\n                if (videoWidth > 0) {\n                    vimeoLink.style.width = `${videoWidth}px`;\n                    console.log(`Vimeo link width adjusted to ${videoWidth}px`);\n                }\n            }\n\n            vimeoLink.classList.add('visible');\n            console.log('Vimeo link displayed');\n        } else if (!vimeoLink) {\n            console.log('Vimeo link element not found (optional element)');\n        }\n    }\n\n    /**\n     * ローディングオーバーレイを隠す（UI調整含む）\n     */\n    hideLoadingOverlay(): void {\n        this.progressManager.hideLoadingOverlay();\n\n        if (this.angleDisplay) {\n            this.adjustAngleDisplayPosition();\n        }\n\n        this.showVimeoLink();\n    }\n\n    /**\n     * エラー表示\n     */\n    showError(title: string, message: string): void {\n        this.progressManager.showError(title, message);\n    }\n}\n","// CSSをインポート\nimport './turntable-viewer.css';\nimport type { TurntableConfig, TurntableState } from './types';\nimport { ProgressManager } from './progress-manager';\nimport { VideoConfigManager } from './video-config-manager';\nimport { PlayerInitializer } from './player-initializer';\nimport { DragHandler } from './drag-handler';\nimport { UIManager } from './ui-manager';\nimport { getErrorMessage, delay } from './utils';\n\n/**\n * Web Turntable Viewer\n * ドラッグ操作で360度回転表示を制御するクラス\n */\nclass TurntableViewer {\n    private container: HTMLElement;\n    private iframe: HTMLIFrameElement;\n    private dragOverlay: HTMLElement;\n    private config: TurntableConfig;\n    private state: TurntableState;\n    private isReloading: boolean = false;\n\n    // マネージャークラス\n    private progressManager: ProgressManager;\n    private videoConfigManager: VideoConfigManager;\n    private playerInitializer: PlayerInitializer;\n    private dragHandler: DragHandler | null = null;\n    private uiManager: UIManager;\n\n    constructor(containerId: string) {\n        // DOM要素の取得\n        const container = document.getElementById(containerId);\n        if (!container) {\n            throw new Error(`Container element with id \"${containerId}\" not found`);\n        }\n        this.container = container;\n\n        const iframe = this.container.querySelector<HTMLIFrameElement>('iframe');\n        if (!iframe) {\n            throw new Error('iframe element not found in container');\n        }\n        this.iframe = iframe;\n\n        const angleEl = this.container.querySelector<HTMLElement>('#rotation-angle');\n        const angleDisplay = this.container.querySelector<HTMLElement>('#angle-display');\n\n        const dragOverlay = this.container.querySelector<HTMLElement>('.drag-overlay');\n        if (!dragOverlay) {\n            throw new Error('drag-overlay element not found in container');\n        }\n        this.dragOverlay = dragOverlay;\n\n        // プログレスバー関連要素\n        const loadingOverlay = this.container.querySelector<HTMLElement>('.loading-overlay');\n        const loadingText = this.container.querySelector<HTMLElement>('.loading-text');\n        const progressFill = this.container.querySelector<HTMLElement>('.progress-fill');\n        const progressText = this.container.querySelector<HTMLElement>('.progress-text');\n\n        if (!loadingOverlay || !loadingText || !progressFill || !progressText) {\n            throw new Error('Required loading elements not found in container');\n        }\n\n        // ProgressManagerを初期化\n        this.progressManager = new ProgressManager(\n            this.container,\n            this.iframe,\n            loadingOverlay,\n            loadingText,\n            progressFill,\n            progressText\n        );\n\n        // DOM要素の存在確認\n        console.log('DOM elements check:');\n        console.log('- container:', !!this.container);\n        console.log('- iframe:', !!this.iframe);\n        console.log('- loadingOverlay:', !!loadingOverlay);\n        console.log('- progressFill:', !!progressFill);\n        console.log('- progressText:', !!progressText);\n        console.log('- loadingText:', !!loadingText);\n        console.log('- angleEl (optional):', !!angleEl);\n        console.log('- angleDisplay (optional):', !!angleDisplay);\n\n        // 必須要素のチェック\n        if (!this.container || !this.iframe || !loadingOverlay) {\n            throw new Error('Required elements not found: container, iframe, or loading-overlay');\n        }\n\n        console.log('DOM elements validation passed');\n\n        // 設定を取得\n        try {\n            this.config = this.getConfig();\n            console.log('Configuration loaded:', this.config);\n        } catch (error) {\n            const message = getErrorMessage(error);\n            console.error('Configuration error:', message);\n            this.showError('Configuration Error', message);\n            throw error;\n        }\n\n        // 状態管理\n        this.state = {\n            player: null,\n            duration: 0,\n            isPlayerReady: false,\n            isDragging: false,\n            dragStartX: 0,\n            startTime: 0,\n            lastDragUpdate: 0,\n            lastDisplayedAngle: null,\n            pendingApiCall: null\n        };\n\n        // マネージャークラスを初期化\n        this.videoConfigManager = new VideoConfigManager(this.container, this.iframe, this.config);\n        this.playerInitializer = new PlayerInitializer(this.container, this.iframe);\n        this.uiManager = new UIManager(\n            this.container,\n            this.iframe,\n            angleEl,\n            angleDisplay,\n            this.config,\n            this.state,\n            this.progressManager,\n            this.handleReload.bind(this)\n        );\n\n        // 初期化\n        this.initialize();\n    }\n\n    /**\n     * 設定を取得\n     */\n    getConfig(): TurntableConfig {\n        const videoId = this.container.getAttribute('vimeo-video-id');\n        const clockwiseAttr = this.container.getAttribute('clockwise-rotation');\n        let isClockwise = true;\n\n        if (clockwiseAttr !== null) {\n            if (clockwiseAttr === '' || clockwiseAttr === 'true' || clockwiseAttr === '1') {\n                isClockwise = true;\n            } else if (clockwiseAttr === 'false' || clockwiseAttr === '0') {\n                isClockwise = false;\n            } else {\n                console.warn(`Invalid clockwise-rotation attribute value: \"${clockwiseAttr}\". Using default \"true\".`);\n                isClockwise = true;\n            }\n        }\n\n        if (!videoId) {\n            throw new Error('vimeo-video-id attribute is required on the container element');\n        }\n\n        if (!/^\\d+$/.test(videoId)) {\n            throw new Error(`Invalid vimeo-video-id format: \"${videoId}\". Only numeric IDs are allowed.`);\n        }\n\n        return {\n            RESIZE_DEBOUNCE_MS: 500,\n            PLAYER_LOAD_DELAY_MS: 1000,\n            DRAG_THROTTLE_MS: 16,\n            isClockwise: isClockwise,\n            videoId: videoId\n        };\n    }\n\n    /**\n     * 初期化\n     */\n    async initialize(): Promise<void> {\n        this.uiManager.hideAngleDisplay();\n        this.progressManager.showLoadingOverlay();\n\n        try {\n            await this.initializePlayer();\n            this.attachEventListeners();\n            console.log('TurntableViewer initialized successfully');\n\n            this.uiManager.showAngleDisplay();\n        } catch (error) {\n            console.error('TurntableViewer initialization failed:', error);\n            this.progressManager.updateProgress(100, '初期化エラーが発生しました');\n            this.uiManager.hideLoadingOverlay();\n        }\n    }\n\n    /**\n     * リロード処理\n     */\n    async handleReload(): Promise<void> {\n        if (this.isReloading) return;\n\n        this.isReloading = true;\n        this.uiManager.setReloadLoading(true);\n\n        try {\n            console.log('Reloading turntable viewer...');\n\n            // DragHandlerのイベントリスナーを削除\n            if (this.dragHandler) {\n                this.dragHandler.removeEventListeners();\n                this.dragHandler = null;\n            }\n\n            // iframe情報をプレイヤー破棄前に保存（destroy が iframe を削除する可能性があるため）\n            if (!this.iframe || !this.iframe.parentElement) {\n                console.error('iframe or parent element not found, cannot reload');\n                throw new Error('Cannot reload: iframe element not properly initialized');\n            }\n\n            const parent = this.iframe.parentElement;\n            const oldId = this.iframe.id;\n            const oldClassName = this.iframe.className;\n            const oldWidth = this.iframe.getAttribute('width') || '';\n            const oldHeight = this.iframe.getAttribute('height') || '';\n\n            // プレイヤーを破棄\n            if (this.state.player) {\n                try {\n                    await this.state.player.destroy();\n                    console.log('Player destroyed successfully');\n                } catch (e) {\n                    console.warn('Error destroying player:', e);\n                }\n                this.state.player = null;\n            }\n\n            // 古いiframeを削除（既に destroy で削除されている可能性があるため確認）\n            if (this.iframe.parentElement) {\n                this.iframe.remove();\n                console.log('Old iframe removed');\n            } else {\n                console.log('iframe already removed by player.destroy()');\n            }\n\n            // 新しいiframe要素を作成\n            const newIframe = document.createElement('iframe');\n            newIframe.id = oldId;\n            newIframe.className = oldClassName;\n            newIframe.setAttribute('allow', 'autoplay; fullscreen; picture-in-picture');\n            newIframe.setAttribute('loading', 'lazy');\n\n            // サイズ属性を即座に設定してリサイズを防ぐ\n            if (oldWidth) newIframe.setAttribute('width', oldWidth);\n            if (oldHeight) newIframe.setAttribute('height', oldHeight);\n\n            // 新しいiframeを挿入\n            parent.appendChild(newIframe);\n            this.iframe = newIframe;\n            console.log('iframe element recreated with size:', oldWidth, 'x', oldHeight);\n\n            // マネージャークラスのiframe参照を更新\n            this.videoConfigManager = new VideoConfigManager(this.container, this.iframe, this.config);\n            this.playerInitializer = new PlayerInitializer(this.container, this.iframe);\n\n            // 少し待機してブラウザがDOMを更新するのを待つ\n            await delay(300);\n\n            // 状態をリセット\n            this.state = {\n                player: null,\n                duration: 0,\n                isPlayerReady: false,\n                isDragging: false,\n                startTime: 0,\n                dragStartX: 0,\n                lastDragUpdate: 0,\n                pendingApiCall: null,\n                lastDisplayedAngle: 0\n            };\n\n            this.progressManager.resetTimeout();\n\n            // 再初期化\n            await this.initialize();\n\n        } catch (error) {\n            console.error('Reload failed:', error);\n        } finally {\n            this.isReloading = false;\n            this.uiManager.setReloadLoading(false);\n        }\n    }\n\n    /**\n     * Vimeoプレイヤー初期化\n     */\n    async initializePlayer(): Promise<void> {\n        try {\n            // 初期サイズを設定\n            await this.videoConfigManager.setInitialSizeFromAPI(\n                (progress, message) => {\n                    this.progressManager.updateProgress(progress, message);\n                },\n                () => {\n                    this.progressManager.adjustLoadingOverlaySize();\n                }\n            );\n\n            // 動画URLを構築してiframeを設定\n            this.videoConfigManager.setupVideoPlayer();\n\n            this.progressManager.updateProgress(20, 'Creating player...');\n\n            // iframeが新しいURLをロードするまで待機（リロード時は長めに）\n            if (this.isReloading) {\n                await delay(2000);\n                console.log('Extended delay for reload');\n            } else {\n                await delay(this.config.PLAYER_LOAD_DELAY_MS);\n            }\n\n            // プレイヤーを作成\n            this.state.player = await this.playerInitializer.createPlayer((progress, message) => {\n                this.progressManager.updateProgress(progress, message);\n            });\n\n            // プレイヤーが完全にロードされるまで待機（リロード時はさらに長めに）\n            if (this.isReloading) {\n                await delay(2000);\n                console.log('Extended player load delay for reload');\n            } else {\n                await delay(this.config.PLAYER_LOAD_DELAY_MS);\n            }\n            this.progressManager.updateProgress(60, 'Loading player settings...');\n\n            // プレイヤーの基本情報取得\n            this.state.duration = await this.playerInitializer.getPlayerDuration(\n                this.state.player,\n                this.isReloading,\n                (progress, message) => this.progressManager.updateProgress(progress, message)\n            );\n\n            // 動画のアスペクト比を調整\n            await this.playerInitializer.adjustVideoAspectRatio(\n                this.state.player,\n                () => this.progressManager.adjustLoadingOverlaySize()\n            );\n\n            this.progressManager.updateProgress(75, 'Applying player settings...');\n\n            // プレイヤー設定を適用\n            await this.playerInitializer.applyPlayerSettings(this.state.player);\n\n            // 動画の事前バッファリング（オプショナル）\n            await this.playerInitializer.preloadVideo(\n                this.state.player,\n                this.state.duration,\n                (progress, message) => this.progressManager.updateProgress(progress, message)\n            );\n\n            this.progressManager.updateProgress(90, 'Setting initial state...');\n\n            // 初期状態設定\n            await this.playerInitializer.setInitialPlayerState(this.state.player);\n\n            // 初期角度表示を更新\n            this.uiManager.updateAngle(0);\n\n            this.state.isPlayerReady = true;\n            console.log('Player ready');\n\n            // プログレス完了\n            this.progressManager.updateProgress(100, 'Initialization complete!');\n\n            // ローディングオーバーレイを隠す\n            setTimeout(() => {\n                this.uiManager.hideLoadingOverlay();\n            }, 500);\n\n        } catch (error) {\n            console.error('Player initialization failed:', error);\n\n            const errorMessage = getErrorMessage(error);\n            if (errorMessage.includes('Failed to create Vimeo player')) {\n                this.showError('プレイヤーエラー', 'ビデオプレイヤーを作成できませんでした。接続を確認してリロードしてください。');\n            } else if (errorMessage.includes('Video not found')) {\n                this.showError('ビデオが見つかりません', '指定されたビデオが見つかりませんでした。ビデオIDを確認してください。');\n            } else if (errorMessage.includes('Access denied')) {\n                this.showError('アクセス拒否', 'このビデオは非公開または制限されています。ビデオの権限を確認してください。');\n            } else if (errorMessage.includes('Failed to get video duration')) {\n                this.showError('ビデオ情報の取得に失敗', 'ビデオの長さを取得できませんでした。ネットワーク接続を確認してリロードしてください。');\n            } else {\n                this.showError('初期化エラー', `ビデオプレイヤーの読み込みに失敗しました。<br><br>エラー: ${errorMessage}<br><br>リロードボタンを押して再試行してください。`);\n            }\n\n            this.videoConfigManager.setInitialSizeFallback(() => {\n                this.progressManager.adjustLoadingOverlaySize();\n            });\n            console.log('Error state maintained, loading overlay not hidden');\n        }\n    }\n\n    /**\n     * イベントリスナーの追加\n     */\n    attachEventListeners(): void {\n        // DragHandlerを作成\n        this.dragHandler = new DragHandler(\n            this.container,\n            this.dragOverlay,\n            this.state,\n            this.config,\n            () => this.videoConfigManager.calculatePixelsPerRotation(),\n            (seconds) => this.uiManager.updateAngle(seconds)\n        );\n\n        this.dragHandler.attachEventListeners();\n        window.addEventListener('resize', this.onWindowResize.bind(this));\n    }\n\n    /**\n     * ウィンドウリサイズイベントハンドラー\n     */\n    async onWindowResize(): Promise<void> {\n        const newQuality = this.videoConfigManager.selectVideoQuality();\n        const currentSrc = this.iframe.src;\n\n        if (!currentSrc.includes(`quality=${newQuality}`)) {\n            console.log('Reinitializing player due to quality change:', newQuality);\n            this.state.isPlayerReady = false;\n            await this.initializePlayer();\n        }\n\n        const newPixelsPerRotation = this.videoConfigManager.calculatePixelsPerRotation();\n        console.log('Window resized, new PIXELS_PER_ROTATION:', newPixelsPerRotation);\n    }\n\n    /**\n     * エラー表示（ProgressManagerを使用）\n     */\n    private showError(title: string, message: string): void {\n        this.progressManager.showError(title, message);\n    }\n\n    /**\n     * エラー表示（非推奨：後方互換性のため残す）\n     */\n    private showError_old(title: string, message: string): void {\n        this.uiManager.showError(title, message);\n    }\n\n    /**\n     * クリーンアップ\n     */\n    destroy(): void {\n        if (this.dragHandler) {\n            this.dragHandler.removeEventListeners();\n        }\n        window.removeEventListener('resize', this.onWindowResize.bind(this));\n        console.log('TurntableViewer destroyed');\n    }\n}\n\n// グローバルな初期化済みコンテナを追跡\nif (!window.turntableViewerInstances) {\n    window.turntableViewerInstances = new Set();\n}\n\n// 初期化関数\nfunction initializeTurntableViewers(): void {\n    const containers = document.querySelectorAll('[vimeo-video-id]');\n\n    if (containers.length === 0) {\n        console.warn('No turntable containers found. Make sure elements have vimeo-video-id attribute.');\n        return;\n    }\n\n    console.log(`Found ${containers.length} turntable container(s), checking for new instances...`);\n\n    containers.forEach((container, index) => {\n        try {\n            if (!container.id) {\n                container.id = `turntable-container-${Date.now()}-${index}`;\n                console.log(`Auto-generated ID: ${container.id}`);\n            }\n\n            if (window.turntableViewerInstances.has(container.id)) {\n                console.log(`TurntableViewer already initialized for container: ${container.id}`);\n                return;\n            }\n\n            new TurntableViewer(container.id);\n            window.turntableViewerInstances.add(container.id);\n            console.log(`TurntableViewer initialized for container: ${container.id}`);\n        } catch (error) {\n            console.error(`Failed to initialize TurntableViewer for container ${index}:`, error);\n        }\n    });\n}\n\n// DOMContentLoadedイベントで初期化\ndocument.addEventListener('DOMContentLoaded', initializeTurntableViewers);\n\n// スクリプトが動的に読み込まれた場合にも対応\nif (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', initializeTurntableViewers);\n} else {\n    initializeTurntableViewers();\n}\n\n// ESモジュールとしてクラスをエクスポート\nexport { TurntableViewer };\n\n// グローバルにも公開(後方互換性のため)\nif (typeof window !== 'undefined') {\n    window.TurntableViewer = TurntableViewer;\n}\n"],"names":["ProgressManager","container","iframe","loadingOverlay","loadingText","progressFill","progressText","percentage","text","angleDisplay","iframeWidth","iframeHeight","defaultHeight","now","totalLoadingTime","timeSinceLastProgress","title","message","getErrorMessage","error","delay","ms","resolve","withTimeout","promise","timeoutMs","errorMessage","_","reject","VideoConfigManager","config","htmlWidth","containerWidth","computedWidth","finalWidth","pixelsPerRotation","videoWidth","videoHeight","htmlHeight","finalHeight","area","effectiveArea","devicePixelRatio","effectiveSize","limitedDPR","selectedQuality","quality","screenWidth","_a","availableWidth","params","url","oembedUrl","controller","timeoutId","response","data","aspectRatio","onProgress","onAdjustOverlay","currentWidth","currentHeight","videoInfo","calculatedHeight","calculatedWidth","defaultWidth","videoUrl","PlayerInitializer","player","isReloading","timeout","duration","currentAspectRatio","settings","setting","preloadPoints","i","point","seekTime","actions","action","DragHandler","dragOverlay","state","calculatePixelsPerRotation","onAngleUpdate","deltaX","rotationProgress","timeDelta","currentX","newTime","err","startX","UIManager","angleEl","progressManager","onReload","isLoading","seconds","angle","roundedAngle","wasHidden","vimeoLink","TurntableViewer","containerId","videoId","clockwiseAttr","isClockwise","parent","oldId","oldClassName","oldWidth","oldHeight","e","newIframe","progress","newQuality","newPixelsPerRotation","initializeTurntableViewers","containers","index"],"mappings":"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"}